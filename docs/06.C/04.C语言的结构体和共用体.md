---
title: 04.C语言的结构体和共用体
date: 2025-10-15 23:00:00
permalink: /pages/C_04/
---

# C语言结构体与共用体

在C语言中，除了基本数据类型（如`int`、`float`、`char`）外，我们还需要描述**由多个不同类型组成的复杂数据**，比如学生信息、坐标点、寄存器状态等。
 这时就要用到两位老朋友——**结构体（struct）** 和 **共用体（union）**。

------

## 一、结构体（struct）——把不同类型的数据“打包”在一起

### 🔹1. 定义方式

```c
struct Student {
    char name[20];
    int age;
    float score;
};
```

这定义了一个叫 `Student` 的结构体类型，包含三个成员：`name`、`age`、`score`。
 但注意！这样定义还**没有创建变量**。

### 🔹2. 定义变量的几种方式

#### ✅ 方法1：先定义类型，再定义变量

```c
struct Student s1;
```

#### ✅ 方法2：定义时直接声明变量

```c
struct Student {
    char name[20];
    int age;
    float score;
} s1, s2;
```

#### ✅ 方法3：使用 `typedef` 简化写法

这是最常见的写法，尤其在嵌入式中。

```c
typedef struct {
    char name[20];
    int age;
    float score;
} Student;

Student s1; // 不用再写 struct
```

------

### 🔹3. 初始化与访问

```c
#include <stdio.h>

typedef struct {
    char name[20];
    int age;
    float score;
} Student;

int main() {
    Student stu1 = {"ZhangSan", 20, 95.5};

    // 访问结构体成员
    printf("姓名：%s\n", stu1.name);
    printf("年龄：%d\n", stu1.age);
    printf("成绩：%.1f\n", stu1.score);

    return 0;
}
```

结构体成员访问用 **点运算符 `.`**。
 如果是指针，则用 **箭头运算符 `->`**：

```c
Student *p = &stu1;
printf("姓名：%s\n", p->name);
```

------

### 🔹4. 结构体嵌套与数组

结构体可以嵌套定义，也可以作为数组使用：

```c
typedef struct {
    char name[20];
    int age;
} Student;

typedef struct {
    Student leader;
    Student members[3];
} Group;
```

------

### 🔹5. 注意点与常见坑

| ⚠️注意事项                    | 说明                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| **内存对齐**                 | 结构体的成员可能会因对齐规则而导致内存中有“空洞”。顺序不同会影响大小。 |
| **初始化顺序**               | 必须按照定义顺序初始化。                                     |
| **结构体赋值**               | 同类型结构体可以直接赋值，如 `stu2 = stu1;`。                |
| **函数传参**                 | 若结构体较大，推荐用指针传递，否则会复制整个结构体。         |
| **与 `#pragma pack()` 配合** | 在嵌入式开发中可控制对齐方式以节省空间或匹配寄存器格式。     |

------

## 二、共用体（union）——多种成员共享同一段内存

### 🔹1. 定义与特点

共用体（联合体）与结构体类似，但所有成员**共用一块内存**。

```c
union Data {
    int i;
    float f;
    char str[20];
};
```

特点：

- 所有成员从内存的同一个地址开始；
- 共用体的大小 = **最大成员的大小**；
- 同一时刻只存储一个成员的有效值。

------

### 🔹2. 示例：理解内存共享

```c
#include <stdio.h>

union Data {
    int i;
    float f;
    char str[20];
};

int main() {
    union Data data;

    data.i = 10;
    printf("data.i = %d\n", data.i);

    data.f = 3.14;
    printf("data.f = %.2f\n", data.f);
    printf("data.i = %d\n", data.i);  // ⚠️现在 data.i 的值已被覆盖！

    return 0;
}
```

输出可能是：

```c
data.i = 10
data.f = 3.14
data.i = 1078523331
```

这是因为 `data.f` 覆盖了与 `data.i` 共享的内存。

------

### 🔹3. 常见用途

| 用途                           | 说明                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| **节省内存**                   | 例如在嵌入式系统中，一个数据包可以不同格式解析，共用同一存储区。 |
| **类型重解释（Type Punning）** | 在驱动或底层通信中，通过 union 把一段字节解释为不同类型数据。 |
| **寄存器映射**                 | 例如 MCU 的控制寄存器常用结构体+共用体混合表示不同位字段。   |

------

### 🔹4. 注意事项

| ⚠️风险点                          | 说明                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| **只有一个成员有效**             | 同一时间只能使用最后一次写入的成员。                         |
| **类型安全风险**                 | 用于类型重解释时需小心不同平台的字节序（Endian）。           |
| **结构体与共用体嵌套要小心对齐** | 特别是在嵌入式寄存器定义中，需配合 `#pragma pack` 或手动填充字节。 |
