---
title: 08.ç¼–è¯‘åŸç†
date: 2026-02-24 15:00:00
permalink: /pages/Linux_08/
---


## Cè¯­è¨€ç¼–è¯‘è¿‡ç¨‹

### ä¸€ã€ ç¼–è¯‘ C ç¨‹åºæµç¨‹æ¦‚å†µ

- GCC ç¼–è¯‘çš„**4 ä¸ªé˜¶æ®µ**

  1. é¢„å¤„ç†

     ```
     -E
     ```

     - å®å±•å¼€ã€å¤´æ–‡ä»¶å±•å¼€ã€åˆ é™¤æ³¨é‡Šã€æ¡ä»¶ç¼–è¯‘å¤„ç†
     - è¾“å‡ºï¼š`.i` æ–‡ä»¶

  2. ç¼–è¯‘

     ```
     -S
     ```

     - è¯­æ³•è¯­ä¹‰åˆ†æ â†’ ç”Ÿæˆæ±‡ç¼–ä»£ç 
     - è¾“å‡ºï¼š`.s` æ–‡ä»¶

  3. æ±‡ç¼–

     ```
     -c
     ```

     - æ±‡ç¼– â†’ æœºå™¨ç ï¼Œç”Ÿæˆ**ç›®æ ‡æ–‡ä»¶**
     - è¾“å‡ºï¼š`.o` æ–‡ä»¶ï¼ˆELF æ ¼å¼ï¼Œä¸å¯ç›´æ¥æ‰§è¡Œï¼‰

  4. é“¾æ¥ï¼ˆæ— å‚æ•°ï¼‰

     ```
     -o
     ```

     - ç¬¦å·è§£æã€é‡å®šä½ â†’ ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

- å¸¸ç”¨ç¼–è¯‘å‚æ•°

  - `-o`ï¼šæŒ‡å®šè¾“å‡ºæ–‡ä»¶å
  - `-Wall`ï¼šæ‰“å¼€æ‰€æœ‰è­¦å‘Š
  - `-g`ï¼šæ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆGDB ç”¨ï¼‰
  - `-O1/-O2/-O3`ï¼šä¼˜åŒ–ç­‰çº§ï¼ˆåµŒå…¥å¼éå¸¸å…³é”®ï¼‰
  - `-I`ï¼šæŒ‡å®šå¤´æ–‡ä»¶è·¯å¾„
  - `-L`ï¼šæŒ‡å®šåº“æ–‡ä»¶è·¯å¾„
  - `-l`ï¼šé“¾æ¥æ—¶æŒ‡å®šåº“å

### äºŒã€å®æ“è¿‡ç¨‹å’Œç»†èŠ‚ï¼ˆé»˜è®¤å·²æœ‰gccå·¥å…·é“¾ï¼‰

æ“ä½œçš„`.c`å¯¹è±¡

```c
#include <stdio.h>

#define MAX_NUM 100          // â‘  é¢„å¤„ç†ä¼šå±•å¼€

int global_init = 10;        // â‘¡ .data
int global_uninit;           // â‘¢ .bss

void print_info() {
    int local_var = MAX_NUM; // â‘£ æ ˆ
    printf("global_init = %d, local_var = %d\n", global_init, local_var);
}

int main() {
    print_info();
    return 0;
}
```

 4 ä¸ªç‚¹åœ¨**ä¸åŒé˜¶æ®µæ ·å­ä¸åŒ**ã€‚

#### é˜¶æ®µ 1ï¼šé¢„å¤„ç†ï¼ˆ`-E`ï¼‰â€”â€”çº¯æ–‡æœ¬ä¸–ç•Œ

```bash
gcc -E test.c -o test.i
```

è¿™ä¸€æ­¥**ä¸ä¼šç”Ÿæˆä»»ä½•äºŒè¿›åˆ¶**ã€‚

é€šè¿‡`cat`å’Œ`grep`å‘½ä»¤å¯ä»¥çœ‹åˆ°ä¸€äº›ä¿¡æ¯

```bash
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "MAX_NUM" test.i # æ²¡é”™ï¼Œæ²¡æœ‰è¾“å‡ºï¼ä¸€å¼€å§‹æˆ‘ä¹Ÿæ‡µé€¼ï¼Œç„¶åè¿è¡Œäº†næ¬¡
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "100" test.i | head
747:    int local_var = 100;
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "global_init" test.i
743:int global_init = 10;
748:    printf("global_init = %d, local_var = %d\n", global_init, local_var);
```

æ€»ç»“ä¸€ä¸‹ï¼š

`#define MAX_NUM 100`ï¼Œ**å·²ç»å½»åº•æ¶ˆå¤±äº†**ï¼Œç¼–è¯‘å™¨åé¢çš„é˜¶æ®µ**æ ¹æœ¬ä¸çŸ¥é“â€œå®â€è¿™ä¸ªæ¦‚å¿µ**

#include <stdio.h>å±•å¼€æˆå‡ ç™¾è¡Œä»£ç ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°å¾ˆå¤š __printf_chkã€`_builtin_...

**test.i æœ¬è´¨**ï¼šè¿˜æ˜¯ C ä»£ç ï¼Œä½†å·²ç»æ˜¯â€œå±•å¼€åçš„ã€æœ€åŸå§‹â€çš„ C

#### é˜¶æ®µ 2ï¼šç¼–è¯‘ï¼ˆ`-S`ï¼‰â€”â€”ç¬¬ä¸€æ¬¡æ¥è§¦â€œæŒ‡ä»¤çº§ä¸–ç•Œâ€

```bash
gcc -S test.i -o test.s
```

è¿™ä¸€æ­¥æŠŠçº¯æ–‡æœ¬Cæ–‡ä»¶ç¼–è¯‘æˆæ±‡ç¼–æ–‡ä»¶

```bash
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "print_info" test.s
22:	.globl	print_info
23:	.type	print_info, @function
24:print_info:
48:	.size	print_info, .-print_info
61:	call	print_info
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "main:" test.s
51:main:
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "global_init" test.s
3:	.globl	global_init
6:	.type	global_init, @object
7:	.size	global_init, 4
8:global_init:
20:	.string	"global_init = %d, local_var = %d\n"
35:	movl	global_init(%rip), %eax
ikun@ubuntu2004:~/Desktop/c_test$ grep -n "local_var" test.s
20:	.string	"global_init = %d, local_var = %d\n"
```

ä¸Šé¢æ˜¯ä¸€å¤§å †çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæ„æ€ä¸ºâ€¦â€¦

å…³é”®ç†è§£

- `test.s` æ˜¯**æ±‡ç¼–è¯­è¨€æ–‡æœ¬**
- ç¼–è¯‘å™¨å·²ç»ï¼š
  - å†³å®šäº†**è°ƒç”¨çº¦å®š**
  - å†³å®šäº†**æ ˆå¸ƒå±€**
  - å†³å®šäº†**ç”¨å¯„å­˜å™¨è¿˜æ˜¯å†…å­˜**

ä½†å®ƒä»ç„¶ï¼š

-  ä¸çŸ¥é“ `printf` åœ¨å“ª
-  ä¸çŸ¥é“ `global_init` çš„æœ€ç»ˆåœ°å€

#### é˜¶æ®µ 3ï¼šæ±‡ç¼–ï¼ˆ`-c`ï¼‰â€”â€”çœŸæ­£çš„æœºå™¨ç ï¼Œä½†è¿˜ä¸èƒ½è·‘

```bash
gcc -c test.s -o test.o
```

éªŒè¯ä¸€ä¸‹ï¼š

```bash
ikun@ubuntu2004:~/Desktop/c_test$ file test.o
test.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped
```

**é€šè¿‡ file å‘½ä»¤çœ‹åˆ° test.o æ˜¯ "ELF 64-bit LSB relocatable, not stripped"ï¼Œè¿™è¯´æ˜å®ƒæ˜¯åœ¨ Linux ä¸‹çš„æ ‡å‡† 64 ä½åŠæˆå“æ–‡ä»¶ï¼Œéœ€è¦é“¾æ¥æ‰èƒ½è¿è¡Œï¼›è€Œ "not stripped" æ„å‘³ç€å®ƒä¿ç•™äº†å‡½æ•°åå’Œè¡Œå·ç­‰è°ƒè¯•ä¿¡æ¯ï¼Œè®©ä½ èƒ½ç”¨ GDB è°ƒè¯•å·¥å…·æ¸…æ¥šåœ°çœ‹åˆ°ä»£ç æ‰§è¡Œåˆ°å“ªé‡Œï¼Œæ–¹ä¾¿æ’æŸ¥é”™è¯¯ã€‚**

é‡ç‚¹æ˜¯æ®µç»“æ„ï¼š

```bash
ikun@ubuntu2004:~/Desktop/c_test$ readelf -S test.o | grep -E "\.text|\.data|\.bss|\.symtab"
  [ 1] .text             PROGBITS         0000000000000000  00000040
  [ 2] .rela.text        RELA             0000000000000000  00000278
  [ 3] .data             PROGBITS         0000000000000000  00000090
  [ 4] .bss              NOBITS           0000000000000000  00000094
  [11] .symtab           SYMTAB           0000000000000000  00000160
```

| æ®µå      | æ¥è‡ªå“ªé‡Œ                      |
| --------- | ----------------------------- |
| `.text`   | `print_info`ã€`main` çš„æœºå™¨ç  |
| `.data`   | `global_init = 10`            |
| `.bss`    | `global_uninit`               |
| `.symtab` | æ‰€æœ‰å‡½æ•° / å˜é‡åå­—           |

`.bss`ï¼š**ä¸å ç£ç›˜ç©ºé—´**,åªè®°å½•â€œè¦åˆ†é…å¤šå°‘å†…å­˜â€,ç¨‹åºåŠ è½½æ—¶ç”±å†…æ ¸æ¸…é›¶

#### é˜¶æ®µ 4ï¼šé“¾æ¥ â€”â€” ä¸€åˆ‡æ‰â€œçœŸçš„èƒ½è·‘â€

```bash
gcc test.o -o test
```

 gcc å®é™…åšäº†ï¼šld + crt + libc + é‡å®šä½

è¿™æ—¶å€™å°±å¯ä»¥è¿è¡Œäº†

```bash
ikun@ubuntu2004:~/Desktop/c_test$ ./test
global_init = 10, local_var = 100 # å“¦ï¼Œæˆ‘çš„è€å¤©é¹…ï¼Œç»ˆäºæŠŠä½ ç›¼å‡ºæ¥äº†
```

å¯ä»¥æŸ¥çœ‹ä¾èµ–å…³ç³»

```bash
ikun@ubuntu2004:~/Desktop/c_test$ ldd test
	linux-vdso.so.1 (0x00007ffe42702000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x0000718cdf000000)
	/lib64/ld-linux-x86-64.so.2 (0x0000718cdf2f0000)
```

è¿æ¥å™¨å¹²äº†ä¸¤ä»¶äº‹

1. **ç¬¦å·è§£æ**
   - `printf` â†’ libc é‡Œçš„åœ°å€
   - `__libc_start_main` â†’ ç¨‹åºå…¥å£
2. **é‡å®šä½**
   - æŠŠ `.o` é‡Œ `%rip + offset`
   - æ”¹æˆåŠ è½½åèƒ½ç”¨çš„åœ°å€

> ğŸ’¡ æ²¡æœ‰é“¾æ¥å™¨ï¼ŒCPU æ ¹æœ¬ä¸çŸ¥é“â€œä½ åœ¨ call è°â€ã€‚