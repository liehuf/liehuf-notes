---
title: 12.Makefileè§„åˆ™
date: 2026-02-26 22:00:00
permalink: /pages/Linux_12/
---

# Makefileçš„è§„åˆ™

## ä¸€ã€Makefileçš„åŸºæœ¬è§„åˆ™

Makefileè§„åˆ™é•¿å¦‚ä¸‹çš„æ ·å­ï¼š

```makefile
ç›®æ ‡(target): ä¾èµ–(prerequisites)
	å‘½ä»¤(command)
```

å†™Makefileæ—¶ï¼Œå¿…é¡»æ³¨æ„ä¸€ä¸‹ä¸‰ä¸ªè§„åˆ™

- å‘½ä»¤å‰é¢ç¼©è¿›å¿…é¡»æ˜¯`Tab`
- å‘½ä»¤æ˜¯çœŸçš„è¦æ‰§è¡Œçš„Shellå‘½ä»¤
- æ˜¯å¦æ‰§è¡Œå‘½ä»¤å¾—çœ‹æ—¶é—´æˆ³

é€šè¿‡å¦‚ä¸‹çš„ä¾‹å­å®Œæ•´èµ°ä¸€éè„‘å­ï¼š

```makefile
app: test.o math_lib.o
	gcc -o app test.o math_lib.o
```

Make åšçš„äº‹æƒ…æ˜¯ï¼š

1. æˆ‘éœ€è¦ `app`
2. `app` ä¾èµ– `test.o` å’Œ `math_lib.o`
3. é‚£æˆ‘å…ˆå»çœ‹çœ‹ï¼š``test.o` æ€ä¹ˆæ¥ï¼Ÿ`math_lib.o` æ€ä¹ˆæ¥ï¼Ÿ

äºæ˜¯è¿™è´§å‘ä¸‹æ‰¾ï¼Œå•Šï¼Œæ‰¾åˆ°ä½ äº†ï¼

```makefile
test.o: test.c
	gcc -c test.c -o test.o
```

## äºŒã€è§„åˆ™çš„ä¸‰å¤§ç±»

### æ™®é€šè§„åˆ™

```makefile
test.o: test.c
	gcc -c test.c -o test.o
```

ä¸€ä¸ªç›®æ ‡ä¸€ä¸ªè§„åˆ™ï¼Œç®€å•æ¸…æ™°ï¼Œæ–‡ä»¶ä¸€å¤šå°±çˆ†ç‚¸ï¼Œé è¿‘ä¸€ç‚¹å¿«è¢«èåŒ–

é«˜ç«¯çš„ä»ä¸€èˆ¬ä¸è¿™æ ·å†™ï¼Œä½†æ˜¯æˆ‘æ˜¯äºŒèˆ¬çš„æ¥ç€

### æ¨¡å¼è§„åˆ™ï¼ˆè¿™æ‰æ˜¯ä¸»è¦çš„ç”Ÿäº§åŠ›ï¼‰

è­¬å¦‚ï¼š

```makefile
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@
```

`%` = **æ–‡ä»¶åä¸­â€œå˜åŒ–çš„é‚£ä¸€éƒ¨åˆ†â€**test.c â†’ test.o

â€œä»»ä½• `.o` æ–‡ä»¶ï¼Œéƒ½å¯ä»¥ç”±**åŒåçš„ `.c` æ–‡ä»¶**é€šè¿‡è¿™æ¡å‘½ä»¤ç”Ÿæˆâ€ï¼Œè¿™ç»™äº†Makeä¸€æ¡ç”Ÿæˆæ–¹æ³•

å…¶ä¸­ï¼š

- \$<   # ç¬¬ä¸€ä¸ªä¾èµ–ï¼ˆxxx.cï¼‰
- $@   # å½“å‰ç›®æ ‡ï¼ˆxxx.oï¼‰

###  ä¼ªç›®æ ‡ï¼ˆ.PHONYï¼Œå·¥ç¨‹ç»éªŒç‚¹ï¼‰

å½“æˆ‘æœ‰ä¸€ä¸ªæ–‡ä»¶`clean`ï¼Œç„¶åæˆ‘åœ¨Makefileé‡Œé¢å†™é“ï¼š

```makefile
clean:
	rm -f *.o
```

ç„¶åmake cleanä¸€ä¸‹ï¼Œç»“æœï¼ŒMakeä»¥ä¸ºéƒ½æœ‰äº†ï¼Œé‚£æˆ‘å•¥éƒ½ä¸å¹²äº†ï¼ğŸ˜µâ€ğŸ’«

å…¶å®æ­£ç¡®çš„å§¿åŠ¿ä¸ºï¼š

```makefile
.PHONY: clean

clean:
	$(RM) *.o
```

`.PHONY` çš„æ„æ€æ˜¯ï¼š

> **â€œè¿™ä¸ªç›®æ ‡ä¸æ˜¯æ–‡ä»¶åï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå‘½ä»¤å…¥å£ã€‚â€**

## ä¸‰ã€å…¶ä»–çš„æ³¨æ„ç‚¹

1. æœ€ä¸Šé¢çš„æ€»æ˜¯é»˜è®¤ä¾èµ–ï¼Œæœ‰ä¸€ä¸ªçº¦å®šä¿—æˆçš„ `all: app`
2. ä¸€ä¸ªè§„åˆ™å¯æœ‰å¤šä¸ªä¾èµ–ï¼Œä½†åè¿‡æ¥ä¸è¡Œ
3. Makefileçš„æ‰§è¡Œé¡ºåºå¹¶éè‡ªä¸Šè€Œä¸‹ï¼Œè€Œæ˜¯ä¾èµ–è§„åˆ™
4. åœ¨å‘½ä»¤å‰é¢åŠ ä¸€ä¸ª`@`å°±å¯ä»¥è®©å‘½ä»¤è¡Œåœæ­¢å½å½å–³å–³äº†



ä¸€èˆ¬çš„ä¼˜é›…Makefileé•¿è¿™æ ·ï¼š

ä¸€å¥è¯å®šä¹‰ï¼š

> **ä¼˜é›… = ä¸é‡å¤ã€å¯æ‰©å±•ã€æ”¹åŠ¨æˆæœ¬ä½**

```makefile
CC := gcc
CFLAGS := -Wall -g

OBJ := main.o add.o

app: $(OBJ)
	$(CC) -o $@ $^

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@
```

è¿™é‡Œæœ‰å¿…è¦è§£é‡Šä¸€äº›ç‚¹ï¼š

1. `CFLAGS := -Wall -g`ä¸¤ä¸ªé€‰é¡¹ä¹‹ä¸­ï¼Œ
   1. ç¬¬ä¸€ä¸ª`-Wall`æ˜¯Warn allï¼Œä»£è¡¨å‡ ä¹æ‰€æœ‰å¸¸è§è­¦å‘Š
   2. ç¬¬äºŒä¸ª`-g`ä»£è¡¨ç”Ÿæˆè°ƒè¯•ä¿¡æ¯
2. å‘½ä»¤`gcc -o app main.o add.o`çš„ä½œç”¨ä¸æ˜¯ç¼–è¯‘ï¼Œè€Œæ˜¯æ‰“åŒ…ï¼ŒæŠŠ **å·²ç»ç¼–è¯‘å¥½çš„ç›®æ ‡æ–‡ä»¶** `main.o` å’Œ `add.o`**é“¾æ¥** æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ `app`
3. `%.o: %.c`ä»£è¡¨æ¨¡å¼åŒ¹é…ï¼Œè¿™ä¸€ç‚¹æœ‰ç‚¹åƒå¹¿ä¹‰çš„`for`å¾ªç¯ï¼Œè¿™é‡Œçš„`%`ä»£è¡¨åŒåå ä½ç¬¦
