---
title: 09.é™æ€ã€åŠ¨æ€é“¾æ¥
date: 2026-02-24 21:00:00
permalink: /pages/Linux_09/
---

# é™æ€è¿æ¥å’ŒåŠ¨æ€é“¾æ¥çš„å®è·µæ€§ç†è§£

## ä¸€ã€æŠ½è±¡åœ°ç†è§£é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥

> **é™æ€é“¾æ¥ï¼šç¼–è¯‘æ—¶æŠŠâ€œåˆ«äººå†™å¥½çš„ä»£ç â€ç›´æ¥æ‹·è´è¿›ä½ çš„ç¨‹åºé‡Œ**
>  **åŠ¨æ€é“¾æ¥ï¼šç¼–è¯‘æ—¶åªè®°ä¸‹â€œæˆ‘ä»¥åè¦ç”¨è°â€ï¼ŒçœŸæ­£çš„ä»£ç ç­‰ç¨‹åºè¿è¡Œæ—¶å†æ‰¾**

æ³¨æ„è¿™ä¸¤ä¸ªè¯çš„ä¸»è¯­ï¼š

- **é™ / åŠ¨ï¼Œè¯´çš„ä¸æ˜¯ç¨‹åºæœ¬èº«**
- è¯´çš„æ˜¯ï¼š**åº“ä»£ç â€œä»€ä¹ˆæ—¶å€™ã€ä»¥ä»€ä¹ˆæ–¹å¼â€è¿›å…¥ä½ çš„ç¨‹åº**

### ğŸ”¹ ç”¨â€œåšèœâ€æ‰“ä¸ªä¸ä½çº§çš„æ¯”æ–¹

#### é™æ€é“¾æ¥ï¼ˆstaticï¼‰

ä½ åšé¥­æ—¶ï¼šæŠŠ **ç›ã€æ²¹ã€é…±æ²¹ã€é”…å…¨éƒ¨è£…è¿›ä½ è‡ªå·±çš„èƒŒåŒ…ï¼Œå»åˆ°å“ªå„¿ï¼Œéƒ½ç”¨ä½ è‡ªå·±çš„**

ğŸ‘‰ å¥½å¤„ï¼šä¸ä¾èµ–ç¯å¢ƒå¹¶ä¸”æ”¾åˆ°å“ªéƒ½èƒ½è·‘ï¼ˆåµŒå…¥å¼ã€å›ºä»¶å–œæ¬¢ï¼‰

ğŸ‘‰ åå¤„ï¼šèƒŒåŒ…å¾ˆé‡ï¼ˆæ–‡ä»¶å¤§ï¼‰ï¼Œæ¯ä¸ªäººéƒ½èƒŒä¸€å¥—ï¼ˆæµªè´¹å†…å­˜ï¼‰

------

#### åŠ¨æ€é“¾æ¥ï¼ˆdynamicï¼‰

ä½ åšé¥­æ—¶ï¼šèƒŒåŒ…é‡Œ**ä¸å¸¦é”…**ï¼Œåªå†™ä¸€å¼ çº¸ï¼šâ€œæˆ‘è¦ç”¨ 3 å·å¨æˆ¿çš„é”…â€

ç­‰ä½ **çœŸæ­£å¼€å§‹åšé¥­ï¼ˆç¨‹åºè¿è¡Œï¼‰**ï¼šç³»ç»ŸæŠŠé”…ç»™ä½ ï¼Œå¤šä¸ªäººè¿˜èƒ½å…±ç”¨åŒä¸€å£é”…

ğŸ‘‰ å¥½å¤„ï¼šç¨‹åºå°ï¼Œå†…å­˜å¯å…±äº«

ğŸ‘‰ åå¤„ï¼šå¨æˆ¿æ²¡é”…ï¼Œä½ å°±å®Œè›‹ï¼ˆè¿è¡Œæ—¶æŠ¥é”™ï¼‰

---

## äºŒã€ç¼–å†™å¥½çš„åº“æ–‡ä»¶

```c
#ifndef MATH_LIB_H	// å¤´æ–‡ä»¶
#define MATH_LIB_H

int add(int a, int b);
int mul(int a, int b);

#endif
```

```c
#include "math_lib.h" // æºæ–‡ä»¶

int add(int a, int b) {
    return a + b;
}

int mul(int a, int b) {
    return a * b;
}
```

## ä¸‰ã€é™æ€é“¾æ¥ï¼šä»£ç â€œæ‹·è´â€è¿›å¯æ‰§è¡Œæ–‡ä»¶

é™æ€é“¾æ¥çš„æ ¸å¿ƒåªæœ‰ä¸€å¥è¯ï¼š

> **ç›®æ ‡æ–‡ä»¶é‡Œçš„ä»£ç ï¼Œè¢«ç›´æ¥åˆå¹¶è¿›æœ€ç»ˆ ELFã€‚**

ä»¥ä¸‹æ˜¯æ‰“åŒ…å¹¶ç¼–è¯‘è¾“å‡ºçš„è¿‡ç¨‹ï¼š

```bash
ikun@ubuntu2004:~/Desktop/link_test$ gcc -c math_lib.c -o math_lib.o	# ç”Ÿæˆç›®æ ‡æ–‡ä»¶
ikun@ubuntu2004:~/Desktop/link_test$ file math_lib.o	# æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ç±»å‹
math_lib.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped # è¿™æ˜¯ä¸€ä¸ªè¿˜æ²¡è¢«é“¾æ¥çš„â€œé›¶ä»¶â€
ikun@ubuntu2004:~/Desktop/link_test$ ar rcs libmath.a math_lib.o	# æŠŠ.oæ–‡ä»¶æ‰“åŒ…æˆ.aæ–‡ä»¶ï¼Œlibmathè¿™ä¸ªåå­—æ˜¯æ‰¾mathç›¸å…³çš„æ–‡ä»¶
```

ç¼–å†™`test_lib.c`æ–‡ä»¶ç”¨äºæµ‹è¯•

```c
#include <stdio.h>
#include "math_lib.h"

int main() {
    int a = 5, b = 3;
    printf("a + b = %d\n", add(a, b));
    printf("a * b = %d\n", mul(a, b));
    return 0;
}
```

ä½¿ç”¨å‘½ä»¤ï¼š

```bash
ikun@ubuntu2004:~/Desktop/link_test$ gcc test_lib.c -o test_static -static -L. -lmath
```

- `-static`é€‰é¡¹è¡¨ç¤ºç”Ÿæˆé™æ€é“¾æ¥ï¼Œä½œç”¨æ˜¯æŠŠç¨‹åºè¿è¡Œéœ€è¦çš„æ‰€æœ‰ä¾èµ–æ‰“åŒ…ï¼Œå¦‚æœä¸åŠ ï¼Œåˆ™ä¸ºåŠ¨æ€åº“
- `-L.` è¡¨ç¤ºä¼˜å…ˆåœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾
- `-lmath`è¡¨ç¤ºç”Ÿæˆçš„æ–‡ä»¶åï¼Œè§„åˆ™æ˜¯è‡ªåŠ¨åœ¨å‰é¢åŠ libï¼Œåœ¨åé¢åŠ .a

æœ€åè¿›è¡ŒéªŒè¯ï¼š

```bash
ikun@ubuntu2004:~/Desktop/link_test$ ls -lh test_static # -lä»£è¡¨ä»¥é•¿æ ¼å¼æ˜¾ç¤ºä¿¡æ¯ï¼Œ-hä»£è¡¨humanlize,äººæ€§åŒ–
-rwxrwxr-x 1 ikun ikun 880K  2æœˆ 24 20:18 test_static
ikun@ubuntu2004:~/Desktop/link_test$ ldd test_static
	ä¸æ˜¯åŠ¨æ€å¯æ‰§è¡Œæ–‡ä»¶
ikun@ubuntu2004:~/Desktop/link_test$ nm test_static | grep -E " add$| mul$"
00000000004017b0 T add
00000000004017c8 T mul
```

- æ–‡ä»¶è¾ƒå¤§
- ä¸æ˜¯åŠ¨è¯­é“¾æ¥
- å·²å®šä¹‰å‡½æ•°ä»£ç æ®µ

------

## å››ã€åŠ¨æ€é“¾æ¥ï¼šç¬¦å·â€œå¼•ç”¨â€ä¸è¿è¡Œæ—¶è§£æ

åŠ¨æ€é“¾æ¥å¹¶ä¸æ‹·è´ä»£ç ï¼Œè€Œæ˜¯ç•™ä¸‹â€œæ¬ æ¡â€ã€‚

> ELF é‡Œåªè®°å½•ï¼šâ€œæˆ‘éœ€è¦ä¸€ä¸ªå« `add` çš„ç¬¦å·ï¼Œå®ƒåœ¨æŸä¸ªå…±äº«åº“é‡Œï¼Œè‡³äºåœ¨å“ªé‡Œï¼Œä¿ºä¸ä¸­å˜â€

é¦–å…ˆä»æ—§æˆæˆç›®æ ‡æ–‡ä»¶

```bash
ikun@ubuntu2004:~/Desktop/link_test$ gcc -c math_lib.c -o math_lib_pico.o -fPIC
```

-fPIC çš„æ„ä¹‰:-fPIC è®©ä»£ç ä¸ä¾èµ–å›ºå®šåœ°å€ï¼Œé€šè¿‡ GOT/PLT é—´æ¥å¯»å€ï¼Œä½¿åŒä¸€ä»½ä»£ç èƒ½è¢«å¤šä¸ªè¿›ç¨‹å…±äº«

```bash
ikun@ubuntu2004:~/Desktop/link_test$ gcc -shared -o libmath.so math_lib_pico.o
ikun@ubuntu2004:~/Desktop/link_test$ file libmath.so
libmath.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=f701bf17254bed35c1ab68eea4487c995377e054, not stripped
```

 `-shared`é€‰é¡¹ ï¼š**ä¸è¦ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºï¼Œç”Ÿæˆâ€œå¯è¢«åŠ è½½çš„å…±äº«å¯¹è±¡â€ã€‚**

å®ƒä¼šè®©é“¾æ¥å™¨ï¼šä¸è¦æ±‚ `main`ï¼Œå…è®¸æœªè§£æç¬¦å·ï¼Œç”Ÿæˆ `.so` ç±»å‹ ELF

ç”ŸæˆåŠ¨æ€åº“åæŸ¥ä¸€ä¸‹æˆ·å£ï¼ˆä¾èµ–å…³ç³»ã€æŠŠæ–‡ä»¶æ‰’å¼€çœ‹çœ‹é‡Œé¢æœ‰å“ªäº›å‡½æ•°ï¼‰

```bash
ikun@ubuntu2004:~/Desktop/link_test$ ldd test_dynamic
	linux-vdso.so.1 (0x00007ffd9bdf4000)
	libmath.so => ./libmath.so (0x0000748d6e61a000)	# è¿™ä¸€ä¸ªåº“ä¸ºç”¨æˆ·æ‰“åŒ…çš„åº“
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x0000748d6e200000)
	/lib64/ld-linux-x86-64.so.2 (0x0000748d6e626000)
ikun@ubuntu2004:~/Desktop/link_test$ nm test_dynamic | grep -E " add$| mul$"
                 U add  # UæŒ‡çš„æ˜¯æœªå®šä¹‰ï¼Œè¿™æ˜¯ä¸€ç§è®¾è®¡ï¼Œè€Œå¹¶éé”™è¯¯
                 U mul
```

æ¥ä¸‹æ¥æœ‰ä¸€ä¸ªæŠ¥é”™ï¼Œé€šè¿‡åŠ äº†ä¸€ä¸ªç¯å¢ƒå˜é‡è§£å†³ï¼š

```bash
kun@ubuntu2004:~/Desktop/link_test$ ./test_dynamic
./test_dynamic: error while loading shared libraries: libmath.so: cannot open shared object file: No such file or directory
ikun@ubuntu2004:~/Desktop/link_test$ export LD_LIBRARY_PATH=./:$LD_LIBRARY_PATH
ikun@ubuntu2004:~/Desktop/link_test$ ./test_dynamic
a + b = 8
a * b = 15
```

å«ä¹‰æ˜¯ï¼šåŠ¨æ€é“¾æ¥å™¨åœ¨è¿è¡Œç¨‹åºæ—¶ï¼Œå…ˆä» `./` è¿™ä¸ªç›®å½•æ‰¾ `.so`ï¼Œå†æ‰¾ç³»ç»Ÿé»˜è®¤è·¯å¾„ã€‚

