---
title: 03.进程管理
date: 2026-02-20 23:00:00
permalink: /pages/Linux_03/
---

## Linux进程与资源管理

## 一、进程观察

PID 是什么

- **PID = Process ID，进程号**
- 内核给每个运行中的程序分配的**唯一身份证号**
- 所有操作进程的命令（kill、top、strace 等）都靠 PID 定位

CPU% 怎么来的？

> **单位时间内，进程占用 CPU 的时间比例**

- 比如 100% 就是单核跑满
- 多核机器可以超过 100%（比如 250% 就是占了 2.5 核）
- 是**动态计算**出来的，不是固定值

VIRT vs RES

- **VIRT（虚拟内存）**

  进程**声称要用**的所有内存总和

  = 物理内存 + 交换分区 + 共享库 + 未分配但申请过的空间

  → **虚的，参考意义不大**

  

- **RES（常驻内存）**

  进程**真正正在占用的物理内存**

  → **看这个才准**

在命令行中输入：`ps aux`

会显示如下内容：
```shell
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  1.6  0.5 166580 11544 ?        Ss   20:56   0:02 /sbin/init au
root           2  0.0  0.0      0     0 ?        S    20:56   0:00 [kthreadd]
```

这一大堆输出中，意义如下：

| 列名    | 含义                      | 举例                        |
| ------- | ------------------------- | --------------------------- |
| USER    | 进程所属用户              | root / 你的用户名           |
| PID     | 进程 ID（唯一标识）       | 1 / 1234 / 5678             |
| %CPU    | CPU 占用百分比            | 0.0 / 1.5 / 10.2            |
| %MEM    | 内存占用百分比            | 0.1 / 2.3                   |
| VSZ     | 虚拟内存（VIRT），单位 KB | 123456                      |
| RSS     | 常驻内存（RES），单位 KB  | 67890                       |
| COMMAND | 进程对应的命令            | sleep 1000 / bash / systemd |

解读重要内容：

**PID**： `PID=1` 的进程是 `systemd`，这是 Linux 的第一个进程（所有进程的爹）；

**%CPU**：比如有个进程 % CPU=50.0，说明它占了当前单核的 50% 算力（如果是 4 核机器，最大能到 400%）；

**VIRT vs RES**：比如某进程 VIRT=200000KB，RES=50000KB → 真正占物理内存的是 50000KB，VIRT 是 “宣称要用的总内存”（包含没实际使用的）。

---

如果要实时监控进程，则需要使用`top`命令：

```shell
top
```

使用后，自动定时刷新当前进程，可以使用快捷键`q`退出，也可以

```shell
# 按 M 键 - 按内存排序
# 按 u 后输入用户名 - 查看特定用户进程
# 按 k 后输入 PID - 终止进程
```

## 二、进程状态

在运行`top`命令后，在其S(state)列中，可能会出现如下的字符

**R = Running**

正在运行或在就绪队列排队

**S = Sleeping**

可中断睡眠（等 IO、等时间、等信号）

大部分进程平时都是 S

**Z = Zombie 僵尸进程**

子进程死了，但父进程没 “收尸”（没调用 wait）

→ 只占 PID，不占资源，太多会炸

---

### 新建一个进程并管理它

```
sleep 100 &  # & 表示后台运行
```

终端会返回类似 `[1] 12345`（12345 是这个 sleep 的 PID）。

切回 top 界面，按 `P` 排序，找到 PID=12345 的进程，看它的 `S` 列 → 是 `S`（睡眠，因为 sleep 在等时间）。

示例：

```shell
ikun@ubuntu2004:~$ sleep 100 &
[1] 4134
```

返回的 **4134**就是PID

使用`jobs`命令会显示出当前后台运行的进程

```shell
ikun@ubuntu2004:~$ jobs
[1]+  运行中               sleep 100 &
```

可以分别使用`fg`和`bg`命令让进程在前台和后台运行，如

```shell
ikun@ubuntu2004:~$ fg %1 # 此处的1是指后台进程号，就是在创建进程时返回的数字
sleep 100
^Z	# 通过按下 ^Z 来停止前台进程
[1]+  已停止               sleep 100
ikun@ubuntu2004:~$ bg %1
[1]+ sleep 100 &
```

## 三、信号机制

> **信号 = 内核与进程之间的控制指令**

```shell
sleep 1000 # 会返回一个PID，可在另一个终端里面退出这个进程
		  # 在其他进程中也可以通过“ps aux | grap sleep”命令来查看PID
```

```shell
kill -15 PID   # 温柔退出
kill -9 PID    # 强制杀死
```

**重点理解**：

- **15 SIGTERM**：

  告诉进程 “你可以退出了，请自己清理资源”

  程序可以**拒绝、处理、优雅退出**

  

- **9 SIGKILL**：

  **内核直接干掉进程，不给程序反应时间**

  无法被捕获、无法被忽略、**必杀**

## 四、Systemd基础

### 查看全部服务

在终端中运行命令：

```shell
systemctl list-units --type=service
```

显示如下：

```shell
ikun@ubuntu2004:~$ systemctl list-units --type=service
  UNIT                                                  LOAD   ACTIVE SUB     DESCRIPTION        >
  accounts-daemon.service                               loaded active running Accounts Service
  acpid.service                                         loaded active running ACPI event daemon
  alsa-restore.service                                  loaded active exited  Save/Restore Sound >
  apparmor.service                                      loaded active exited  Load AppArmor profi>
  apport.service                                        loaded active exited  LSB: automatic cras>
```

### 核心概念

**Service（服务）**：systemd 定义的 “单元”，本质是配置文件（/etc/systemd/system/），描述如何启动 / 停止一个后台程序；

**Daemon（守护进程）**：服务对应的后台进程（比如 ssh.service 对应的 sshd 进程），特点是脱离终端、后台持续运行、开机自启；

**运行级别替代**：

老 Linux 的 0-6 运行级别（比如 3 是字符界面，5 是图形界面），在 systemd 里被**Target**替代：

- `multi-user.target`：多用户字符界面（对应老级别 3）；

- `graphical.target`：图形界面（对应老级别 5）

  查当前默认 Target：`systemctl get-default`

### 查看`ssh`服务

运行命令：`systemctl status ssh`

```shell
ikun@ubuntu2004:~$ systemctl status ssh
● ssh.service - OpenBSD Secure Shell server
     Loaded: loaded (/lib/systemd/system/ssh.service; enabled; vendor preset: enabled)
     Active: active (running) since Fri 2026-02-20 21:23:24 CST; 45min ago
       Docs: man:sshd(8)
             man:sshd_config(5)
   Main PID: 3627 (sshd)
      Tasks: 1 (limit: 2204)
     Memory: 1.7M
        CPU: 13ms
     CGroup: /system.slice/ssh.service
             └─3627 "sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups"

2月 20 21:23:24 ubuntu2004 systemd[1]: Starting OpenBSD Secure Shell server...
2月 20 21:23:24 ubuntu2004 sshd[3627]: Server listening on 0.0.0.0 port 22.
2月 20 21:23:24 ubuntu2004 sshd[3627]: Server listening on :: port 22.
2月 20 21:23:24 ubuntu2004 systemd[1]: Started OpenBSD Secure Shell server.

```

- **核心服务标识行**

  - `●`：systemd的状态图标，绿色实心圆代表服务正常运行中，如果是红色×代表服务启动失败，灰色○代表服务已停止
  - `ssh.service`：服务的完整单元名称，是systemd中服务的唯一标识符，日常操作时可以用"ssh"简写代替
  - `OpenBSD Secure Shell server`：服务的详细描述信息，说明这是OpenBSD团队开发的SSH远程登录服务

  

- **Loaded（加载状态）**：这一行告诉你服务的配置文件是否被正确加载，是排查服务启动失败的第一步

  - `loaded`：表示配置文件已经成功加载到内存中，如果是"not-found"则说明配置文件丢失
  - `/lib/systemd/system/ssh.service`：服务配置文件的完整存放路径，这是systemd服务的核心配置文件所在位置
  - `enabled`：表示服务已设置为开机自启动，如果是"disabled"则代表开机不会自动启动SSH服务
  - `vendor preset: enabled`：表示Ubuntu系统厂商默认将这个服务设置为开机自启

  

- **Active（运行状态）**：这是最核心的状态行，直接告诉你服务当前是否在运行

  - `active (running)`：服务处于"活跃(运行中)"状态，如果是"inactive (dead)"代表服务已停止，"failed"代表服务启动失败
  - `since Fri 2026-02-20 21:23:24 CST`：服务启动的具体时间点，精确到秒
  - `45min ago`：服务已经稳定运行了45分钟，说明这段时间内没有发生崩溃或重启

  

- **Docs（文档参考）**：告诉你如果想深入了解SSH服务的详细信息，可以通过以下命令查看官方文档

  - `man:sshd(8)`：在终端输入"man sshd"可以查看SSH守护进程的手册页
  - `man:sshd_config(5)`：在终端输入"man sshd_config"可以查看SSH配置文件的详细说明，排查配置问题时特别有用

  

- **资源占用信息**：这些数值可以帮助判断服务是否存在资源异常

  - `Main PID: 3627 (sshd)`：SSH服务的主进程ID是3627，虽然可以用kill命令控制，但不建议手动杀死系统服务
  - `Tasks: 1 (limit: 2204)`：该服务当前只占用1个任务(进程)，系统允许的最大进程数是2204个
  - `Memory: 1.7M`：服务只占用1.7MB物理内存，非常轻量级，如果显示几十GB则说明服务异常
  - `CPU: 13ms`：从启动到现在总共消耗了13毫秒的CPU时间，几乎可以忽略不计，如果显示几秒或几分钟则说明服务一直在占用CPU

  

- **CGroup（控制组）**：systemd用来限制和管理服务资源的机制

  - `/system.slice/ssh.service`：控制组的路径，属于系统级服务(system.slice)
  - `└─3627 "sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups"`：主进程的具体运行命令，`-D`表示以守护进程模式运行，`[listener]`表示正在监听22端口的连接请求

  

- **日志部分**：这是排查问题的核心依据，记录了服务启动的全过程

  - `2月 20 21:23:24 ubuntu2004 systemd[1]: Starting OpenBSD Secure Shell server...`：systemd开始启动SSH服务
  - `2月 20 21:23:24 ubuntu2004 sshd[3627]: Server listening on 0.0.0.0 port 22.`：SSH服务开始监听所有IPv4地址的22端口
  - `2月 20 21:23:24 ubuntu2004 sshd[3627]: Server listening on :: port 22.`：SSH服务开始监听所有IPv6地址的22端口
  - `2月 20 21:23:24 ubuntu2004 systemd[1]: Started OpenBSD Secure Shell server.`：systemd确认SSH服务启动成功
  - 如果日志中出现"error"或"failed"关键词，比如"Port 22 already in use"，就能快速定位启动失败的原因

额外实用命令

- 启动 ssh 服务：`sudo systemctl start ssh`；
- 停止 ssh 服务：`sudo systemctl stop ssh`；
- 设置开机自启：`sudo systemctl enable ssh`；
- 重启服务：`sudo systemctl restart ssh`。