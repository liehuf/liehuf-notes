---
title: 11.Makefile变量
date: 2026-02-26 13:00:00
permalink: /pages/Linux_11/
---

# MakeFile及其变量

## 一、对于Makefile本身的理解

> Makefile 不是“另一种编译器”，它是“编译流程的调度器”。

在初学C时使用`gcc`，编译一个`main.c`只需要

```bash
gcc main.c -o main
```

但是，当工程变成如下的架构，一系列问题都被抛出：哪些.o要输出？哪些.c是新的？交叉编译怎么切换编译器？

```Plain text
main.c
uart.c
spi.c
i2c.c
drivers/
  gpio.c
  timer.c
```

### Makefile的最小模型

```Makefile
目标: 依赖
	命令
```

e.g.

```makefile
app: main.o uart.o
	gcc -o app main.o uart.o
```

这个例子可以读作：

> 我要得到 app，必须先有 main.o 和 uart.o， 如果它们比 app 新，就执行下面的命令。

## 二、变量的定义和分类

### 1. 基础变量

递归展开变量：`=`，用的时候再展开

立即展开变量：`:=`，定义的时候直接展开，值固定

引用方式：

```makefile
$(CC) $(CFLAGS) -o app $(SRC)
```

一般用\$(...)的形式引用

### 2. 自动变量

在执行时，自动填好，以避免手动书写多个重复的文件名，只在**规则命令里面生效**

| 变量 |             含义             |
| :--: | :--------------------------: |
| `$@` |       规则中的目标文件       |
| `$<` |    规则中的第一个依赖文件    |
| `$^` | 规则中的所有依赖文件（去重） |
| `$?` |    比目标新的所有依赖文件    |
| `$*` |     匹配符`%`匹配的部分      |

### 3. 内置变量（Makefile的工程接口）

make **默认已经定义好一些变量**，这些变量可以直接用：

- `CC`：C 编译器
- `AR`：静态库工具
- `RM`：删除命令

### 4. 变量函数（Makefile会处理文件列表）

#### `wildcard` —— 从文件系统取文件

```bash
SRC := $(wildcard src/*.c)
```

> **列出 src 目录下所有 `.c` 文件**，但不递归子目录

#### `patsubst` —— 批量替换

```makefile
OBJ := $(patsubst %.c,%.o,$(SRC))
```

作用：

```makefile
a.c b.c → a.o b.o
```

这是从 `.c` 推导 `.o` 的标准方式。

#### dir / notdir（找目录/文件）

```makefile
$(dir src/test.c)     → src/
$(notdir src/test.c)  → test.c
```

用于：

- 自动创建目录
- 分离路径和文件名