---
title: 04.卷积神经网络
date: 2025-09-17 17:00:49
permalink: /pages/DP_04/
---

## 从全连接到卷积

### 卷积的定义

在数学中，两个函数（如：$f, g: \mathbb{R}^d \to \mathbb{R}$）之间的卷积被定义为：

$$
(f * g)(\mathbf{x}) = \int f(\mathbf{z}) g(\mathbf{x} - \mathbf{z}) d\mathbf{z}.
$$

事实上，卷积是当把一个函数“反转”并移位 $\mathbf{x}$ 时，测量 $f$ 和 $g$ 之间的重叠，即为互相关运算

对于二维张量，其为离散的，$f$的索引$(a,b)$和$g$的索引$(i-a,j-b)$上的对应加和为：

$$
(f * g)(i,j) = \sum_{a} \sum_{b} f(a,b)g(i - a,j - b).
$$

### 通道

图像是一个由高度、宽度和颜色组成的三维张量，所以索引为 $[\mathbf{X}]_{i,j,k}$,其卷积应该调整为 $[\mathbf{V}]_{a,b,c}$,同时，隐藏表示$\mathbf{H}$也用三位张量。

通道是图像或隐藏表示中，用于体现像素多维特征（如颜色）或提取不同空间化学习特征的维度，在多通道卷积中支持特征的多层传递与处理。

为了支持输入$[\mathbf{X}]$和隐藏表示$[\mathbf{H}]$中的多个通道，我们可在V中提添加第四个坐标，即$[\mathbf{V}]_{a,b,c,d}$, 因此，就诞生了如下的等式：

$$
[\mathbf{H}]_{i,j,d} = \sum_{a=-\Delta}^{\Delta} \sum_{b=-\Delta}^{\Delta} \sum_{c} [\mathbf{V}]_{a,b,c,d}[\mathbf{X}]_{i+a,j+b,c}
$$

其中隐藏表示$[\mathbf{H}]$中的索引$d$表示输出通道，而随后的输出将继续以三维张量$[\mathbf{H}]$作为输入进入下一个卷积层。

## 图像卷积

### 互相关运算

在卷积层中，输入张量和核张量通过互相关运算产生输出张量。

如下图：
输入是高度为$3$、宽度为$3$的二维张量（即形状为$3 × 3$）。卷积核的高度和宽度都是$2$，而卷积核窗口（或卷积窗口）的形状由内核的高度和宽度决定（即$2 × 2$）。
![correlation](/img/Dp/correlation.svg)

在二维互相关运算中，卷积窗口从输入张量的左上角开始，从左到右、从上到下滑动。 当卷积窗口滑动到新一个位置时，包含在该窗口中的部分张量与卷积核张量进行按元素相乘，得到的张量再求和得到一个单一的标量值，由此我们得出了这一位置的输出张量值。 在如上例子中，输出张量的四个元素由二维互相关运算得到，这个输出高度为$2$、宽度为$2$，如下所示：

$$ 
\begin{align*} 0 \times 0 + 1 \times 1 + 3 \times 2 + 4 \times 3 &= 0 + 1 + 6 + 12 = 19, \\ 1 \times 0 + 2 \times 1 + 4 \times 2 + 5 \times 3 &= 0 + 2 + 8 + 15 = 25, \\ 3 \times 0 + 4 \times 1 + 6 \times 2 + 7 \times 3 &= 0 + 4 + 12 + 21 = 37, \\ 4 \times 0 + 5 \times 1 + 7 \times 2 + 8 \times 3 &= 0 + 5 + 14 + 24 = 43. \end{align*} 
$$

我们需要足够的空间在图像上“移动”卷积核，输出大小等于输入大小$\mathbf{n}_h × \mathbf{n}_w$, 减去卷积核大小 $\mathbf{k}_h × \mathbf{k}_w$,即：

$$
(n_h - k_h + 1) \times (n_w - k_w + 1)
$$

## 填充和步幅

### 填充

在连续应用许多卷积层之后，输入图像的边界会丢失很多像素，通常使用 **填充**(padding) 来解决这个问题, 一般在输入图像四周填充元素 $0$ 。

如下图，我们将 $3 × 3$ 输入填充到 $5 × 5$，那么其输出就增加为 $4×4$：

![conv-pad](/img/Dp/conv-pad.svg)

通常情况下，如果我们添加 ${p}_h$ 行填充和 $p_w$ 列填充，则输出形状将为：

$$
(n_h - k_h + p_h + 1) \times (n_w - k_w + p_w + 1)
$$

### 步幅

卷积核在输入张量里面滑动，每次滑动的元素即为 **步幅**（stride），一般默认滑动 $1$ 个元素

如下图，为垂直步幅为3，水平步幅为2的二维互相关运算：

![conv-stride](/img/Dp/conv-stride.svg)

通常，当垂直步幅为 $s_h$、水平步幅为 $s_w$ 时，输出形状为：

$$
\lfloor (n_h - k_h + p_h + s_h)/s_h \rfloor \times \lfloor (n_w - k_w + p_w + s_w)/s_w \rfloor
$$

## 多输入多输出通道

每个 RGB 输入图像具有 $3 \times h \times w$ 的形状，称这个大小为 $3$ 的轴为通道(channel) 维度，常用 $c_i$ 来表示输入通道数，$c_o$为输出通道数。

### 多输入通道

当 $c_i > 1$ 时，卷积核就要构造成 $c_i×k_h×k_w$ 的形状，可以对每个通道输入的二位张良和卷积核的二维张量进行互相关运算，再对通道求和的到二维张量。

如下图，是一个有两个输入通道的二维互相关运算的示例：

![conv-multi-in](/img/Dp/conv-multi-in.svg)

计算第一个元素：
$(1 \times 1 + 2 \times 2 + 4 \times 3 + 5 \times 4) + (0 \times 0 + 1 \times 1 + 3 \times 2 + 4 \times 3) = 56$

### 多输出通道

为了得到多输出通道，可以为每个输出通道创建一个形状为 $c_i×k_h×k_w$的卷积核张量，卷积核的形状就为 $c_o×c_i×k_h×k_w$

### 1 x 1 卷积层

1 x 1卷积层的唯一作用在于调整通道数

如下图，互相关计算使用了具有3个输入通道和2个输出通道的 $1×1$ 卷积核。其中，输入和输出具有相同的高度和宽度。

![conv-1x1](/img/Dp/conv-1x1.svg)

## 汇聚层

### 最大汇聚层和平均汇聚层

汇聚层运算符由一个固定的窗口组成，同时汇聚层不包含参数，汇聚层运算是确定的，我们通常计算窗口内所有元素的最大值或平均值，这些操作分别称为最大汇聚层(maximun pooling) 和 平均汇聚层(average pooling)

如下图，汇聚窗口形状为 $2×2$ 的最大汇聚层：

![pooling](/img/Dp/pooling.svg)

