(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{396:function(s,t,a){"use strict";a.r(t);var n=a(2),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("本博客用于记录我在 FPGA 上学习、理解并最终“想通” PWM（脉冲宽度调制）的全过程。"),t("br"),s._v("\n这不是一篇教程，而是一篇"),t("strong",[s._v("阶段性认知总结")]),s._v("。")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"一、重新认识-pwm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、重新认识-pwm"}},[s._v("#")]),s._v(" 一、重新认识 PWM")]),s._v(" "),t("p",[s._v("PWM，全称 Pulse Width Modulation，中文叫"),t("strong",[s._v("脉冲宽度调制")]),s._v("。")]),s._v(" "),t("p",[s._v("如果用一句工程味十足的话来说：")]),s._v(" "),t("blockquote",[t("p",[s._v("PWM 本质上不是在“输出一个模拟量”，"),t("br"),s._v("\n而是在"),t("strong",[s._v("用时间比例来表达一个数值")]),s._v("。")])]),s._v(" "),t("p",[s._v("为了更直观一点，可以想象一个尖叫鸡：")]),s._v(" "),t("ul",[t("li",[s._v("按下，它叫；")]),s._v(" "),t("li",[s._v("松手，它不叫。")])]),s._v(" "),t("p",[s._v("如果我们把时间尺度拉得非常大，比如 100 秒：")]),s._v(" "),t("ul",[t("li",[s._v("按 30 秒、按 70 秒，对人来说几乎没有任何区别。")])]),s._v(" "),t("p",[s._v("但如果把时间尺度缩小到 "),t("strong",[s._v("1ms")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("300us 在叫，700us 不在叫；")]),s._v(" "),t("li",[s._v("和 700us 在叫，300us 不在叫，")])]),s._v(" "),t("p",[s._v("那么宏观世界听到的“响度”显然不同。")]),s._v(" "),t("p",[s._v("这就是"),t("strong",[s._v("时间尺度缩小后，脉冲宽度变化带来的“连续效果”")]),s._v("。"),t("br"),s._v("\n声音如此，亮度如此，电机转速也是如此。")]),s._v(" "),t("p",[s._v("当“每个周期内按下的时间比例”缓慢变化时，"),t("br"),s._v("\n你就会得到一个听起来（或看起来）像“呼吸”的效果——"),t("br"),s._v("\n这就是所谓的 "),t("strong",[s._v("呼吸灯 / 呼吸鸡")]),s._v("。")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"二、一个可复用的-pwm-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、一个可复用的-pwm-模块"}},[s._v("#")]),s._v(" 二、一个可复用的 PWM 模块")]),s._v(" "),t("p",[s._v("在彻底理解官方呼吸灯代码之后，我最终选择把 PWM "),t("strong",[s._v("抽象成一个干净、可复用的模块")]),s._v("。")]),s._v(" "),t("p",[s._v("这个模块只做一件事："),t("br"),s._v(" "),t("strong",[s._v("根据占空比，输出 PWM 波形")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-verilog line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-verilog"}},[t("code",[t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("`timescale")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("ns"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("ns\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 极简、可复用的 PWM 发生器模块")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("module")]),s._v(" pwm_gen #"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("parameter")]),s._v(" CLK_FREQ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50_000")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("_000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 输入时钟频率（默认 50MHz）")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("parameter")]),s._v(" PWM_FREQ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1_000")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PWM 输出频率（默认 1kHz）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("input")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("wire")]),s._v("        clk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 系统时钟")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("input")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("wire")]),s._v("        rst_n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 低电平复位")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("input")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("wire")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  duty"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 占空比（0~999，对应 0%~100%）")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("output")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("wire")]),s._v("        pwm_out           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PWM 输出信号")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PWM 周期内的时钟计数最大值")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("localparam")]),s._v(" PWM_CNT_MAX "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" CLK_FREQ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" PWM_FREQ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("reg")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" cnt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 时钟分频计数器")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("reg")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  pwm_cnt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PWM 周期内的比较计数器（0~999）")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Step 1：时钟分频，产生 PWM 周期基准")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("always @")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("posedge")]),s._v(" clk "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("negedge")]),s._v(" rst_n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("rst_n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16'd0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" PWM_CNT_MAX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16'd0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n            cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1'b1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Step 2：PWM 周期内的计数（0~999）")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("always @")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("posedge")]),s._v(" clk "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("negedge")]),s._v(" rst_n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("rst_n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            pwm_cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10'd0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" PWM_CNT_MAX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            pwm_cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pwm_cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10'd999")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10'd0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pwm_cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1'b1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Step 3：核心逻辑 —— 时间比较生成 PWM")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("assign")]),s._v(" pwm_out "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pwm_cnt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" duty"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("endmodule")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br")])]),t("p",[s._v("该模块的特点：")]),s._v(" "),t("ul",[t("li",[s._v("默认生成 "),t("strong",[s._v("1kHz PWM")])]),s._v(" "),t("li",[t("code",[s._v("duty")]),s._v(" 为输入，占空比 0~999")]),s._v(" "),t("li",[s._v("与具体“呼吸算法”解耦")]),s._v(" "),t("li",[s._v("可直接复用于 LED、电机、DAC 等场景")])]),s._v(" "),t("p",[s._v("在我看来，这种模块更像是一个"),t("strong",[s._v("工具")]),s._v("，\n而不是某块开发板的“展示性示例”。")]),s._v(" "),t("h2",{attrs:{id:"三、踩坑与反思"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、踩坑与反思"}},[s._v("#")]),s._v(" 三、踩坑与反思")]),s._v(" "),t("p",[s._v("写对代码，并不意味着实验一定能成功。")]),s._v(" "),t("p",[s._v("在这次实验中，我真实踩到的一个坑是：")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("FPGA 不同 IO BANK 的供电电压和 IO 标准是不同的。")])])]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("ul",[t("li",[s._v("LVCMOS12 对应 1.2V")]),s._v(" "),t("li",[s._v("LVCMOS33 对应 3.3V")])]),s._v(" "),t("p",[s._v("LED 能“亮”，并不代表电平标准是正确的。\n板子“看起来正常”，很多时候只是硬件足够宽容。")]),s._v(" "),t("p",[s._v("此外，这次也再次验证了一件事：")]),s._v(" "),t("blockquote",[t("p",[s._v("一旦实验现象不对，\n就不能无条件相信任何一个模块、任何一段代码，\n更不能迷信“看起来没问题”。")])]),s._v(" "),t("p",[t("strong",[s._v("逐层验证、逐级拆解，才是 FPGA 最朴素也最可靠的调试方式。")])])])}),[],!1,null,null,null);t.default=r.exports}}]);