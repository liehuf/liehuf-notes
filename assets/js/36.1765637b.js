(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{406:function(s,t,a){"use strict";a.r(t);var _=a(2),e=Object(_.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"从-elf-角度理解静态链接与动态链接的本质"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从-elf-角度理解静态链接与动态链接的本质"}},[s._v("#")]),s._v(" 从 ELF 角度理解静态链接与动态链接的本质")]),s._v(" "),t("h2",{attrs:{id:"_1-为什么要自己写一个库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么要自己写一个库"}},[s._v("#")]),s._v(" 1. 为什么要自己写一个库")]),s._v(" "),t("p",[s._v("写库并不是为了“复用几行代码”，而是为了"),t("strong",[s._v("人为制造链接问题")]),s._v("。\n只有当函数不在当前编译单元里，ELF、符号表、重定位、装载器这些东西才会真正出现。")]),s._v(" "),t("p",[s._v("系统库已经被高度封装，看不到链接过程；自己写 "),t("code",[s._v("add / mul")]),s._v(" 这种极小库，反而能清楚观察：")]),s._v(" "),t("ul",[t("li",[s._v("符号什么时候被“解决”")]),s._v(" "),t("li",[s._v("代码是被“拷贝”还是“引用”")]),s._v(" "),t("li",[s._v("ELF 在磁盘态和运行态的差异")])]),s._v(" "),t("p",[s._v("所以写库，本质是在"),t("strong",[s._v("给自己搭一个可控的链接实验场")]),s._v("。")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"_2-静态链接-代码-拷贝-进可执行文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-静态链接-代码-拷贝-进可执行文件"}},[s._v("#")]),s._v(" 2. 静态链接：代码“拷贝”进可执行文件")]),s._v(" "),t("p",[s._v("静态链接的核心只有一句话：")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("目标文件里的代码，被直接合并进最终 ELF。")])])]),s._v(" "),t("h3",{attrs:{id:"ar-的本质"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ar-的本质"}},[s._v("#")]),s._v(" ar 的本质")]),s._v(" "),t("p",[t("code",[s._v("ar")]),s._v(" 并不“懂链接”，它只是把多个 "),t("code",[s._v(".o")]),s._v(" 打包成一个 "),t("strong",[s._v("符号仓库")]),s._v("（"),t("code",[s._v(".a")]),s._v("）：")]),s._v(" "),t("ul",[t("li",[s._v("每个 "),t("code",[s._v(".o")]),s._v(" 仍然是完整的 ELF relocatable object")]),s._v(" "),t("li",[s._v("里面包含 "),t("code",[s._v(".text / .data / .symtab")])])]),s._v(" "),t("p",[s._v("链接器在静态链接时做的事是：")]),s._v(" "),t("ul",[t("li",[s._v("只从 "),t("code",[s._v(".a")]),s._v(" 里 "),t("strong",[s._v("抽取用到的 "),t("code",[s._v(".o")])])]),s._v(" "),t("li",[s._v("把这些 "),t("code",[s._v(".o")]),s._v(" 的代码段直接并入可执行文件")])]),s._v(" "),t("p",[s._v("所以 "),t("code",[s._v(".a")]),s._v(" ≈ 一堆 "),t("code",[s._v(".o")]),s._v(" 的zip。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ikun@ubuntu2004:~/Desktop/link_test$ ar rcs libmath.a math_lib.o "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ar 命令把目标文件.o压缩到.a文件里")]),s._v("\nikun@ubuntu2004:~/Desktop/link_test$ ar "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" libmath.a\nmath_lib.o\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"nm-ldd-的证据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nm-ldd-的证据"}},[s._v("#")]),s._v(" nm / ldd 的证据")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("nm test_static")]),s._v("：把文件扒开来看看里面的函数\n能看到 "),t("code",[s._v("add / mul")]),s._v(" 已经变成 "),t("strong",[s._v("已定义符号（T）")])])]),s._v(" "),t("li",[t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ikun@ubuntu2004:~/Desktop/link_test$ nm test_static "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-E")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" add$| mul$"')]),s._v("\n00000000004017b0 T "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v("\n00000000004017c8 T mul\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("ldd test_static")]),s._v(":查看使用哪些动态库\n看不到 "),t("code",[s._v("libmath.so")]),s._v("，因为根本不需要了")])]),s._v(" "),t("li",[t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ikun@ubuntu2004:~/Desktop/link_test$ ldd test_static\n\t不是动态可执行文件\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])]),s._v(" "),t("p",[t("strong",[s._v("函数已经变成 ELF 自己的一部分")]),s._v("。")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"_3-动态链接-符号-引用-与运行时解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-动态链接-符号-引用-与运行时解析"}},[s._v("#")]),s._v(" 3. 动态链接：符号“引用”与运行时解析")]),s._v(" "),t("p",[s._v("动态链接并不拷贝代码，而是留下“欠条”。")]),s._v(" "),t("blockquote",[t("p",[s._v("ELF 里只记录：\n“我需要一个叫 "),t("code",[s._v("add")]),s._v(" 的符号，它在某个共享库里。”")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ikun@ubuntu2004:~/Desktop/link_test$ gcc "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" math_lib.c "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" math_lib_pico.o "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-fPIC")]),s._v("\nikun@ubuntu2004:~/Desktop/link_test$ gcc "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-shared")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" libmath.so math_lib_pico.o\nikun@ubuntu2004:~/Desktop/link_test$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" libmath.so\nlibmath.so: ELF "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("-bit LSB shared object, x86-64, version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SYSV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", dynamically linked, BuildID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sha1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("f701bf17254bed35c1ab68eea4487c995377e054, not stripped\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"fpic-的意义"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#fpic-的意义"}},[s._v("#")]),s._v(" -fPIC 的意义")]),s._v(" "),t("p",[s._v("动态库里的代码不能假设自己被装载到哪个地址。")]),s._v(" "),t("p",[t("code",[s._v("-fPIC")]),s._v(" 的作用是：")]),s._v(" "),t("ul",[t("li",[s._v("所有对"),t("strong",[s._v("全局符号 / 全局数据")]),s._v("的访问")]),s._v(" "),t("li",[s._v("都改成 "),t("strong",[s._v("经由 GOT / PLT 的间接寻址")])])]),s._v(" "),t("p",[s._v("结果是：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v(".text")]),s._v(" 段位置无关")]),s._v(" "),t("li",[s._v("同一个 "),t("code",[s._v(".so")]),s._v(" 可以被多个进程共享")])]),s._v(" "),t("h3",{attrs:{id:"加了-shared"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#加了-shared"}},[s._v("#")]),s._v(" 加了 "),t("code",[s._v("-shared")]),s._v(" ：")]),s._v(" "),t("p",[s._v("含义是：")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("不要生成可执行程序，\n生成“可被加载的共享对象”。")])])]),s._v(" "),t("p",[s._v("它会让链接器：")]),s._v(" "),t("ul",[t("li",[s._v("不要求 "),t("code",[s._v("main")])]),s._v(" "),t("li",[s._v("允许未解析符号")]),s._v(" "),t("li",[s._v("生成 "),t("code",[s._v(".so")]),s._v(" 类型 ELF")])]),s._v(" "),t("p",[s._v("生成动态库后查一下户口（依赖关系、把文件扒开看看里面有哪些函数）")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ikun@ubuntu2004:~/Desktop/link_test$ ldd test_dynamic\n\tlinux-vdso.so.1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x00007ffd9bdf4000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tlibmath.so "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./libmath.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x0000748d6e61a000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这一个库为用户打包的库")]),s._v("\n\tlibc.so.6 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /lib/x86_64-linux-gnu/libc.so.6 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x0000748d6e200000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t/lib64/ld-linux-x86-64.so.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x0000748d6e626000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nikun@ubuntu2004:~/Desktop/link_test$ nm test_dynamic "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-E")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" add$| mul$"')]),s._v("\n                 U "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# U指的是未定义，这是一种设计，而并非错误")]),s._v("\n                 U mul\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"ld-library-path-的本质"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ld-library-path-的本质"}},[s._v("#")]),s._v(" LD_LIBRARY_PATH 的本质")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kun@ubuntu2004:~/Desktop/link_test$ ./test_dynamic\n./test_dynamic: error "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" loading shared libraries: libmath.so: cannot "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" shared object file: No such "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" or directory\nikun@ubuntu2004:~/Desktop/link_test$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LD_LIBRARY_PATH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./:"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LD_LIBRARY_PATH")]),s._v("\nikun@ubuntu2004:~/Desktop/link_test$ ./test_dynamic\na + b "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\na * b "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("这不是“编译选项”，而是"),t("strong",[s._v("运行时规则")]),s._v("。")]),s._v(" "),t("p",[s._v("含义是：")]),s._v(" "),t("blockquote",[t("p",[s._v("动态链接器在运行程序时，先从 "),t("code",[s._v("./")]),s._v(" 这个目录找 "),t("code",[s._v(".so")]),s._v("，再找系统默认路径。")])]),s._v(" "),t("p",[s._v("它影响的是：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("程序启动阶段")])]),s._v(" "),t("li",[s._v("由 "),t("code",[s._v("/lib64/ld-linux-x86-64.so.2")]),s._v(" 执行")])]),s._v(" "),t("p",[s._v("和 gcc、ld 在"),t("strong",[s._v("编译期完全无关")]),s._v("。")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"_4-add-mul-在两种链接下的命运对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-add-mul-在两种链接下的命运对比"}},[s._v("#")]),s._v(" 4. add / mul 在两种链接下的命运对比")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("项目")]),s._v(" "),t("th",[s._v("静态链接")]),s._v(" "),t("th",[s._v("动态链接")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("add / mul")]),s._v(" "),t("td",[s._v("代码被拷进 ELF")]),s._v(" "),t("td",[s._v("只保留符号引用")])]),s._v(" "),t("tr",[t("td",[s._v("ELF 体积")]),s._v(" "),t("td",[s._v("更大")]),s._v(" "),t("td",[s._v("更小")])]),s._v(" "),t("tr",[t("td",[s._v("运行依赖")]),s._v(" "),t("td",[s._v("无需库文件")]),s._v(" "),t("td",[s._v("依赖 "),t("code",[s._v(".so")])])]),s._v(" "),t("tr",[t("td",[s._v("更新库")]),s._v(" "),t("td",[s._v("需重新编译")]),s._v(" "),t("td",[s._v("替换 "),t("code",[s._v(".so")]),s._v(" 即可")])]),s._v(" "),t("tr",[t("td",[s._v("地址")]),s._v(" "),t("td",[s._v("编译期确定")]),s._v(" "),t("td",[s._v("运行期解析")])])])]),s._v(" "),t("p",[s._v("本质差别不是“快慢”，而是：")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("符号是在编译期解决，还是在运行期解决。")])])]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"_5-芯片-嵌入式视角下的取舍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-芯片-嵌入式视角下的取舍"}},[s._v("#")]),s._v(" 5. 芯片 / 嵌入式视角下的取舍")]),s._v(" "),t("p",[s._v("在芯片与底层系统里，选择非常现实：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("裸机 / Bootloader / ROM")]),s._v(" "),t("ul",[t("li",[s._v("静态链接是唯一选择")]),s._v(" "),t("li",[s._v("没有动态装载器")])])]),s._v(" "),t("li",[t("strong",[s._v("Linux SoC / 用户态程序")]),s._v(" "),t("ul",[t("li",[s._v("动态链接节省内存")]),s._v(" "),t("li",[s._v("多进程共享 "),t("code",[s._v(".so")])])])])]),s._v(" "),t("p",[s._v("这也是为什么：")]),s._v(" "),t("ul",[t("li",[s._v("内核、启动代码几乎全是静态")]),s._v(" "),t("li",[s._v("用户空间库大量使用 "),t("code",[s._v(".so")])])]),s._v(" "),t("p",[s._v("不是“优雅问题”，而是"),t("strong",[s._v("系统能力边界")]),s._v("决定的。")])])}),[],!1,null,null,null);t.default=e.exports}}]);