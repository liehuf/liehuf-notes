(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{412:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"makefile依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#makefile依赖"}},[s._v("#")]),s._v(" Makefile依赖")]),s._v(" "),a("h2",{attrs:{id:"一、基础依赖-makefile中-最小因果单位"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、基础依赖-makefile中-最小因果单位"}},[s._v("#")]),s._v(" 一、基础依赖（Makefile中“最小因果单位”）")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("main.o")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" main.c calc.h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这句话的"),a("strong",[s._v("精确定义")])]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("main.o 的“正确性”由 main.c 和 calc.h 共同决定")])])]),s._v(" "),a("p",[s._v("Makefile只知道"),a("code",[s._v("main.o")]),s._v("是目标，"),a("code",[s._v("main.c")]),s._v("和"),a("code",[s._v("calc.h")]),s._v("是依赖")]),s._v(" "),a("h2",{attrs:{id:"二、依赖链-makefile的递归解析模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、依赖链-makefile的递归解析模型"}},[s._v("#")]),s._v(" 二、依赖链（Makefile的递归解析模型）")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" main.o calc.o\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("main.o")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" main.c calc.h\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("calc.o")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" calc.c calc.h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("Make 不是从上到下执行文件，而是：")]),s._v(" "),a("ol",[a("li",[s._v("指定目标："),a("code",[s._v("make app")])]),s._v(" "),a("li",[s._v("Make 发现："),a("code",[s._v("app")]),s._v(" 依赖 "),a("code",[s._v("main.o calc.o")])]),s._v(" "),a("li",[s._v("Make "),a("strong",[s._v("递归展开依赖树")])]),s._v(" "),a("li",[s._v("直到遇到“没有规则、只剩文件”的节点")])]),s._v(" "),a("p",[s._v("顺序由依赖关系拓扑排序决定，Make保证依赖先生成，目标后生成")]),s._v(" "),a("h2",{attrs:{id:"三、依赖关系进阶-使用-d"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、依赖关系进阶-使用-d"}},[s._v("#")]),s._v(" 三、依赖关系进阶——使用"),a("code",[s._v(".d")])]),s._v(" "),a("p",[s._v("在大工程中依赖特别多，成百上千的那种，这时候，手写那么多"),a("code",[s._v(".c")]),s._v("和"),a("code",[s._v(".h")]),s._v("是及其不智慧的操作，并且Makefile与源码强耦合，维护困难")]),s._v(" "),a("p",[s._v("命令"),a("code",[s._v("gcc -MM main.c")]),s._v("可以运行 "),a("strong",[s._v("预处理器")]),s._v("，解析所有 "),a("code",[s._v("#include")]),s._v("，输出“真实依赖关系”")]),s._v(" "),a("p",[s._v("输出格式是 "),a("strong",[s._v("Makefile 规则")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("main.o")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" main.c a.h b.h c.h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("生成的是一个文件，在目前看来内容很少，不过这只是一个教学性质的演示")]),s._v(" "),a("p",[s._v("选项命令"),a("code",[s._v("-include $(DEPS)")]),s._v("这时候就可以把"),a("code",[s._v(".d")]),s._v("文件包含进来，作为Makefile的一部分，这个和 "),a("strong",[s._v("真·手写")]),s._v("的效果是一样的，里面的规则会参与依赖判断")]),s._v(" "),a("h2",{attrs:{id:"四、增量编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、增量编译"}},[s._v("#")]),s._v(" 四、增量编译")]),s._v(" "),a("p",[s._v("对于一个工程，我们全部编译，称为"),a("strong",[s._v("全量编译")]),s._v("，但是耗费时间长，也浪费资源，我们可以通过实行"),a("strong",[s._v("增量编译")]),s._v("，即只编译修改过的文件，这一点同样通过时间戳来确定")]),s._v(" "),a("p",[s._v("Makefile会看：")]),s._v(" "),a("ul",[a("li",[s._v("依赖文件是否比目标文件新？")]),s._v(" "),a("li",[s._v("新的？那就把你拿出来重新编译！")]),s._v(" "),a("li",[s._v("旧的？那就一边站着吧")])]),s._v(" "),a("h2",{attrs:{id:"五、顺序依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、顺序依赖"}},[s._v("#")]),s._v(" 五、顺序依赖")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("obj/%.o")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" src/%.c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" obj\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("|")]),s._v(" 做了什么？")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("obj")]),s._v(" "),a("strong",[s._v("必须先存在")])]),s._v(" "),a("li",[s._v("但 "),a("code",[s._v("obj")]),s._v(" 的时间戳 "),a("strong",[s._v("不参与是否重编判断")])])]),s._v(" "),a("p",[s._v("底层语义是：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("obj 是“执行前置条件”，不是“重建依据”\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这解决的是：")]),s._v(" "),a("ul",[a("li",[s._v("目录不存在 → 编译失败")]),s._v(" "),a("li",[s._v("目录时间变化 → 不触发重编")])]),s._v(" "),a("h2",{attrs:{id:"六、分析一个优雅的makefile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、分析一个优雅的makefile"}},[s._v("#")]),s._v(" 六、分析一个优雅的Makefile")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义编译器变量 CC，这里指定使用 gcc 编译器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 := 是立即赋值，区别于 = 的延迟赋值，是 Makefile 中定义常量的常用方式")]),s._v("\nCC "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" gcc\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义编译选项变量 CFLAGS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -Wall：开启所有常见的警告信息，帮助发现代码潜在问题")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -g：生成调试信息，可配合 gdb 等调试工具使用")]),s._v("\nCFLAGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" -Wall -g\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义源文件列表变量 SRC")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含项目中所有的 .c 源文件，这里是 main.c 和 calc.c")]),s._v("\nSRC "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" main.c calc.c\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成目标文件列表变量 OBJ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $(SRC:.c=.o) 是 Makefile 的字符串替换语法：将 SRC 中所有 .c 后缀替换为 .o")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终 OBJ = main.o calc.o")]),s._v("\nOBJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SRC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(".c"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".o"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成依赖文件列表变量 DEPS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同样使用字符串替换，将 SRC 中 .c 替换为 .d，.d 文件用于存储头文件依赖关系")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终 DEPS = main.d calc.d")]),s._v("\nDEPS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SRC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(".c"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义最终可执行文件目标 app，依赖于所有的 .o 目标文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当 OBJ 中的文件有更新时，会执行下面的编译链接命令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OBJ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 链接所有目标文件生成可执行文件 app")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $(CC) 展开为 gcc，-o app 指定输出文件名为 app，$(OBJ) 展开为所有 .o 文件")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -o app "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OBJ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 模式规则：匹配所有 .o 文件的生成规则")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# %.o 是通配符，表示任意以 .o 结尾的文件，依赖于对应的 %.c 文件（如 main.o 依赖 main.c）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("%.o")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" %.c\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译单个 .c 文件生成对应的 .o 目标文件")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $(CFLAGS) 展开为 -Wall -g，-c 表示只编译不链接")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $< 是自动变量，表示当前规则的第一个依赖文件（即对应的 .c 文件）")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $@ 是自动变量，表示当前规则的目标文件（即对应的 .o 文件）")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CFLAGS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -c "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$<")]),s._v(" -o "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$@")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 生成依赖文件 .d：-MM 选项会分析 .c 文件的头文件依赖，输出格式为 "目标文件: 依赖头文件"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $*.d 中 $* 表示去掉后缀的文件名（如 main.c 对应 main.d）")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -MM "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$<")]),s._v(" > "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$*.d")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含所有 .d 依赖文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -include 表示如果 .d 文件不存在或有错误，Make 不会报错，只会继续执行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作用是让 Make 感知到头文件的变化，头文件修改后会重新编译对应的 .c 文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("-include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("DEPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义 clean 伪目标，用于清理编译生成的文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 伪目标不是实际的文件，只是一个命令集合，执行 make clean 时会运行下面的命令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token target symbol"}},[s._v("clean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm -f 强制删除文件，不会因为文件不存在报错")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除可执行文件 app、所有 .o 目标文件、所有 .d 依赖文件")]),s._v("\n\trm -f app *.o *.d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);