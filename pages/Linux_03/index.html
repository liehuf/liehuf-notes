<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>03.shell 脚本 | 原码纪事</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/eryajf/tu/img/image_20220720_132133.ico">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-LPRG9SPLFF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LPRG9SPLFF');
    </script>
    <meta name="description" content="vdoing博客主题模板">
    <meta name="keywords" content="猎户f,golang,vue,go-web,go-admin,go-ldap-admin">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.e44029f7.css" as="style"><link rel="preload" href="/assets/js/app.62496645.js" as="script"><link rel="preload" href="/assets/js/2.b05449e5.js" as="script"><link rel="preload" href="/assets/js/53.fa262586.js" as="script"><link rel="prefetch" href="/assets/js/10.27a52e0f.js"><link rel="prefetch" href="/assets/js/11.798f9121.js"><link rel="prefetch" href="/assets/js/12.ab89fd8b.js"><link rel="prefetch" href="/assets/js/13.2cb93b36.js"><link rel="prefetch" href="/assets/js/14.f040223f.js"><link rel="prefetch" href="/assets/js/15.48d3e6c5.js"><link rel="prefetch" href="/assets/js/16.5b9202ef.js"><link rel="prefetch" href="/assets/js/17.15c06e3f.js"><link rel="prefetch" href="/assets/js/18.fd831488.js"><link rel="prefetch" href="/assets/js/19.78cb8c8a.js"><link rel="prefetch" href="/assets/js/20.f4013685.js"><link rel="prefetch" href="/assets/js/21.26e344eb.js"><link rel="prefetch" href="/assets/js/22.7954653f.js"><link rel="prefetch" href="/assets/js/23.487d7c23.js"><link rel="prefetch" href="/assets/js/24.5b971d39.js"><link rel="prefetch" href="/assets/js/25.36359c3b.js"><link rel="prefetch" href="/assets/js/26.2cac4fcc.js"><link rel="prefetch" href="/assets/js/27.7cdfcd0c.js"><link rel="prefetch" href="/assets/js/28.57bb5f16.js"><link rel="prefetch" href="/assets/js/29.20609328.js"><link rel="prefetch" href="/assets/js/3.97f03c39.js"><link rel="prefetch" href="/assets/js/30.9eb0a867.js"><link rel="prefetch" href="/assets/js/31.1895fcc4.js"><link rel="prefetch" href="/assets/js/32.7915b90b.js"><link rel="prefetch" href="/assets/js/33.21d9ffa9.js"><link rel="prefetch" href="/assets/js/34.c908d4a2.js"><link rel="prefetch" href="/assets/js/35.69292d7d.js"><link rel="prefetch" href="/assets/js/36.ac5d035b.js"><link rel="prefetch" href="/assets/js/37.20d6194a.js"><link rel="prefetch" href="/assets/js/38.c95440dd.js"><link rel="prefetch" href="/assets/js/39.c6f15be7.js"><link rel="prefetch" href="/assets/js/4.07797cc4.js"><link rel="prefetch" href="/assets/js/40.cf1bbbd7.js"><link rel="prefetch" href="/assets/js/41.7d8c954d.js"><link rel="prefetch" href="/assets/js/42.50c73395.js"><link rel="prefetch" href="/assets/js/43.024f58d3.js"><link rel="prefetch" href="/assets/js/44.e6bf0e31.js"><link rel="prefetch" href="/assets/js/45.71602a24.js"><link rel="prefetch" href="/assets/js/46.ed0ff06c.js"><link rel="prefetch" href="/assets/js/47.17956cc4.js"><link rel="prefetch" href="/assets/js/48.fa351001.js"><link rel="prefetch" href="/assets/js/49.cff08b0a.js"><link rel="prefetch" href="/assets/js/5.5dca0b0f.js"><link rel="prefetch" href="/assets/js/50.4bde50b1.js"><link rel="prefetch" href="/assets/js/51.3ee4c23a.js"><link rel="prefetch" href="/assets/js/52.43f61846.js"><link rel="prefetch" href="/assets/js/54.638902e7.js"><link rel="prefetch" href="/assets/js/55.76ddef25.js"><link rel="prefetch" href="/assets/js/56.2465ae5a.js"><link rel="prefetch" href="/assets/js/57.dc155ffe.js"><link rel="prefetch" href="/assets/js/58.2a6bdcdf.js"><link rel="prefetch" href="/assets/js/59.91e97a74.js"><link rel="prefetch" href="/assets/js/6.034eb6aa.js"><link rel="prefetch" href="/assets/js/60.b971cf67.js"><link rel="prefetch" href="/assets/js/61.540b3e6b.js"><link rel="prefetch" href="/assets/js/62.5f8e2414.js"><link rel="prefetch" href="/assets/js/7.5cadde86.js"><link rel="prefetch" href="/assets/js/8.5bb2cccc.js"><link rel="prefetch" href="/assets/js/9.537c0f11.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e44029f7.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/base/bar.png" alt="原码纪事" class="logo"> <span class="site-name can-hide">原码纪事</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/Notes/" class="nav-link">博客笔记</a></div><div class="nav-item"><a href="/pages/Projects/" class="nav-link">工程</a></div><div class="nav-item"><a href="/pages/Teasting/" class="nav-link">吐槽</a></div><div class="nav-item"><a href="/message-board/" class="nav-link">留言板</a></div><div class="nav-item"><a href="https://blog.yuanmajishi.top/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/Notes/" class="nav-link">博客笔记</a></div><div class="nav-item"><a href="/pages/Projects/" class="nav-link">工程</a></div><div class="nav-item"><a href="/pages/Teasting/" class="nav-link">吐槽</a></div><div class="nav-item"><a href="/message-board/" class="nav-link">留言板</a></div><div class="nav-item"><a href="https://blog.yuanmajishi.top/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/Linux_01/" class="sidebar-link">01.Linux 的常用命令</a></li><li><a href="/pages/Linux_02/" class="sidebar-link">02.nano 编辑器</a></li><li><a href="/pages/Linux_03/" aria-current="page" class="active sidebar-link">03.shell 脚本</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_0-约定与开头-shebang-执行环境" class="sidebar-link">0. 约定与开头（shebang / 执行环境）</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_1-变量-var-分类、命名规则与使用" class="sidebar-link">1. 变量（Var）：分类、命名规则与使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#_1-1-变量的-三类-概念" class="sidebar-link">1.1 变量的 “三类” 概念</a></li><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#_1-2-命名规则" class="sidebar-link">1.2 命名规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#_1-3-赋值与引用" class="sidebar-link">1.3 赋值与引用</a></li><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#_1-4-导出环境变量" class="sidebar-link">1.4 导出环境变量</a></li><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#_1-5-特殊-位置变量-常用" class="sidebar-link">1.5 特殊/位置变量（常用）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_2-变量扩展-parameter-expansion-强烈建议掌握" class="sidebar-link">2. 变量扩展（parameter expansion）——强烈建议掌握</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_3-引号与命令替换-务必谨记" class="sidebar-link">3. 引号与命令替换（务必谨记）</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_4-数组-bash-特性" class="sidebar-link">4. 数组（Bash 特性）</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_5-算术计算" class="sidebar-link">5. 算术计算</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_6-条件判断-vs-vs-test" class="sidebar-link">6. 条件判断：[ ] vs [[ ]] vs test</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_7-循环、break-与-continue" class="sidebar-link">7. 循环、break 与 continue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#循环结构" class="sidebar-link">循环结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/Linux_03/#break-与-continue" class="sidebar-link">break 与 continue</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_8-函数-组织脚本逻辑的最好方式" class="sidebar-link">8. 函数（组织脚本逻辑的最好方式）</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_9-i-o、重定向、管道与-here-doc" class="sidebar-link">9. I/O、重定向、管道与 here-doc</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_10-echo-vs-printf" class="sidebar-link">10. echo vs printf</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_11-错误处理、trap-与清理" class="sidebar-link">11. 错误处理、trap 与清理</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_12-常用工具-安全建议-最佳实践" class="sidebar-link">12. 常用工具/安全建议（最佳实践）</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_13-参数解析-getopts-推荐-示例" class="sidebar-link">13. 参数解析：getopts（推荐）示例</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_14-典型脚本模板-可拷贝到任何项目" class="sidebar-link">14. 典型脚本模板（可拷贝到任何项目）</a></li><li class="sidebar-sub-header level2"><a href="/pages/Linux_03/#_15-综合实例-把上面要点都串起来-robust-log-tool-sh" class="sidebar-link">15. 综合实例（把上面要点都串起来） — robust_log_tool.sh</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Linux</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/liehuf/" target="_blank" title="作者" class="beLink" data-v-06225672>猎户f</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2025-09-28</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">03.shell 脚本<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="shell-脚本-bash"><a href="#shell-脚本-bash" class="header-anchor">#</a> Shell 脚本（Bash）</h1> <hr> <h2 id="_0-约定与开头-shebang-执行环境"><a href="#_0-约定与开头-shebang-执行环境" class="header-anchor">#</a> 0. 约定与开头（shebang / 执行环境）</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-euo</span> pipefail
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><code>#!/usr/bin/env bash</code>：更可移植，按 <code>PATH</code> 找 bash；相比 <code>/bin/bash</code> 更适用于共享脚本。</li> <li><code>set -euo pipefail</code>：
<ul><li><code>-e</code>：任何命令返回非0则脚本退出（避免忽略错误）。</li> <li><code>-u</code>：未定义变量报错（避免拼写类 bug）。</li> <li><code>-o pipefail</code>：管道中任一命令失败时返回失败（对管道很重要）。</li></ul></li></ul> <hr> <h2 id="_1-变量-var-分类、命名规则与使用"><a href="#_1-变量-var-分类、命名规则与使用" class="header-anchor">#</a> 1. 变量（Var）：分类、命名规则与使用</h2> <h3 id="_1-1-变量的-三类-概念"><a href="#_1-1-变量的-三类-概念" class="header-anchor">#</a> 1.1 变量的 “三类” 概念</h3> <ul><li><strong>系统变量（system variables）</strong>：由操作系统/Shell 提供，通常大写，例如 <code>PATH</code>, <code>HOME</code>, <code>SHELL</code>, <code>UID</code>, <code>PWD</code>。</li> <li><strong>环境变量（environment variables）</strong>：对当前 shell 及其子进程有效。通过 <code>export VAR=value</code> 设置/导出。</li> <li><strong>用户（shell）变量 / 局部变量</strong>：仅在当前 shell（或函数）中有效，不会自动传递给子进程，通常不导出。</li></ul> <h3 id="_1-2-命名规则"><a href="#_1-2-命名规则" class="header-anchor">#</a> 1.2 命名规则</h3> <ul><li>只能包含字母、数字和下划线 <code>_</code>。</li> <li>不能以数字开头（例如 <code>1var</code> 错误）。</li> <li>推荐使用小写做脚本内部变量（例如 <code>log_file</code>），系统/环境变量仍用大写（<code>PATH</code>、<code>HOME</code>）。</li> <li>避免覆盖已有 shell 变量（例如 <code>PATH</code>、<code>HOME</code>、<code>IFS</code> 等），如果需要，先了解其含义。</li></ul> <h3 id="_1-3-赋值与引用"><a href="#_1-3-赋值与引用" class="header-anchor">#</a> 1.3 赋值与引用</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;ikun&quot;</span>        <span class="token comment"># 赋值（注意：等号两边不能有空格）</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$name</span>&quot;</span>      <span class="token comment"># 引用（双引号推荐）</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>经过双引号 <code>&quot;$var&quot;</code> 的引用会保留空格并避免字段分裂。</li> <li>单引号 <code>'...'</code> 会完全禁止变量替换；双引号 <code>&quot;...&quot;&quot;</code> 会允许替换但保留空格。</li></ul> <h3 id="_1-4-导出环境变量"><a href="#_1-4-导出环境变量" class="header-anchor">#</a> 1.4 导出环境变量</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">MYVAR</span><span class="token operator">=</span><span class="token string">&quot;hello&quot;</span>
<span class="token comment"># 在当前 shell 中可见，并传递给子进程</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看环境变量：</p> <ul><li><code>env</code> 或 <code>printenv</code> 或 <code>export -p</code></li></ul> <h3 id="_1-5-特殊-位置变量-常用"><a href="#_1-5-特殊-位置变量-常用" class="header-anchor">#</a> 1.5 特殊/位置变量（常用）</h3> <ul><li><code>$0</code>：脚本名</li> <li><code>$1</code>, <code>$2</code>, ...：第 1、第 2 个参数</li> <li><code>$#</code>：参数个数</li> <li><code>&quot;$@&quot;</code>：按独立参数扩展（推荐循环时使用）</li> <li><code>&quot;$*&quot;</code>：合并成一个字符串（通常不如 <code>&quot;$@&quot;</code> 安全）</li> <li><code>$?</code>：上一个命令返回值（退出状态）</li> <li><code>$$</code>：当前 shell 的 PID</li> <li><code>$!</code>：上一个后台进程的 PID</li> <li><code>$PWD</code> / <code>$OLDPWD</code>：当前/上一个目录</li> <li><code>$UID</code>：当前用户 id</li></ul> <hr> <h2 id="_2-变量扩展-parameter-expansion-强烈建议掌握"><a href="#_2-变量扩展-parameter-expansion-强烈建议掌握" class="header-anchor">#</a> 2. 变量扩展（parameter expansion）——强烈建议掌握</h2> <p>参数扩展极其强大，以 <code>${...}</code> 形式为主：</p> <ul><li><code>${var:-default}</code>：如果 <code>var</code> 未定义或为空，则返回 <code>default</code>（不赋值）。</li> <li><code>${var:=default}</code>：如果 <code>var</code> 未定义或为空，则把 <code>default</code> 赋给 <code>var</code> 并返回它。</li> <li><code>${var:+alt}</code>：如果 <code>var</code> 已定义且非空，返回 <code>alt</code>，否则返回空。</li> <li><code>${var:?err}</code>：如果 <code>var</code> 未设置或为空，则打印 <code>err</code> 并退出（常用于必需变量检查）。</li> <li><code>${#var}</code>：字符串长度。</li> <li><code>${var:offset:length}</code>：子串（类似 Python 切片）。</li> <li><code>${var#pattern}</code> / <code>${var##pattern}</code>：从左删最短/最长匹配（前缀）。</li> <li><code>${var%pattern}</code> / <code>${var%%pattern}</code>：从右删最短/最长匹配（后缀）。</li> <li><code>${var//search/replace}</code>：全局替换（字符串）。</li></ul> <p>示例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">${LOG_DIR<span class="token operator">:=</span><span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>myapp}</span>&quot;</span>  <span class="token comment"># 如果未设置则赋默认值</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${FILENAME<span class="token operator">%</span>.*}</span>&quot;</span>          <span class="token comment"># 去掉文件扩展名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr> <h2 id="_3-引号与命令替换-务必谨记"><a href="#_3-引号与命令替换-务必谨记" class="header-anchor">#</a> 3. 引号与命令替换（务必谨记）</h2> <ul><li><strong>单引号 <code>'...'</code></strong>：完全原样，不做变量替换。</li> <li><strong>双引号 <code>&quot;...&quot;&quot;</code></strong>：变量和命令替换会发生，但空格不会被分割。</li> <li><strong>无引号</strong>：字段会被 word-splitting（按 IFS）和 glob（通配符）扩展——危险。</li> <li><strong>命令替换</strong>：
<ul><li><code>$(command)</code> 推荐（可嵌套、易读）</li> <li><code>command</code> 旧式语法，复杂时容易出错</li></ul></li></ul> <p>例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> <span class="token parameter variable">-1</span> *.log<span class="token variable">)</span></span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;There are <span class="token variable"><span class="token variable">$(</span><span class="token function">wc</span> <span class="token parameter variable">-l</span> <span class="token operator">&lt;</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span><span class="token variable">)</span></span> lines in <span class="token variable">$file</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr> <h2 id="_4-数组-bash-特性"><a href="#_4-数组-bash-特性" class="header-anchor">#</a> 4. 数组（Bash 特性）</h2> <p>声明与访问：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">declare</span> <span class="token parameter variable">-a</span> <span class="token assign-left variable">arr</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;one&quot;</span> <span class="token string">&quot;two&quot;</span> <span class="token string">&quot;three&quot;</span><span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${arr<span class="token punctuation">[</span>0<span class="token punctuation">]</span>}</span>&quot;</span>         <span class="token comment"># one</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${arr<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>&quot;</span>         <span class="token comment"># 所有元素（每个作为独立字段）</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${<span class="token operator">#</span>arr<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>&quot;</span>        <span class="token comment"># 元素个数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>遍历：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">v</span> <span class="token keyword">in</span> <span class="token string">&quot;<span class="token variable">${arr<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$v</span>&quot;</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr> <h2 id="_5-算术计算"><a href="#_5-算术计算" class="header-anchor">#</a> 5. 算术计算</h2> <ul><li>使用 <code>$(( ... ))</code> 或 <code>let</code>：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">y</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span> x <span class="token operator">+</span> <span class="token number">5</span> <span class="token variable">))</span></span>
<span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>注意整数与浮点：Bash 本身只支持整数。浮点需用 <code>bc</code>、<code>awk</code> 或 <code>python</code>。</li></ul> <hr> <h2 id="_6-条件判断-vs-vs-test"><a href="#_6-条件判断-vs-vs-test" class="header-anchor">#</a> 6. 条件判断：<code>[ ]</code> vs <code>[[ ]]</code> vs <code>test</code></h2> <ul><li><code>[ expr ]</code> 是 POSIX test，<code>[[ expr ]]</code> 是 bash 扩展（更强，支持正则运算符 <code>=~</code>，不需要大量转义）。</li> <li>常用文件测试：
<ul><li><code>-f file</code>：普通文件存在</li> <li><code>-d dir</code>：目录存在</li> <li><code>-r file</code>：可读、<code>-w</code> 可写、<code>-x</code> 可执行</li></ul></li> <li>字符串测试：
<ul><li><code>-z str</code>：为空</li> <li><code>-n str</code>：非空</li> <li><code>str1 = str2</code> 或 <code>==</code>（在 <code>[[ ]]</code>）</li></ul></li> <li>数值测试：
<ul><li><code>-eq</code>, <code>-ne</code>, <code>-lt</code>, <code>-le</code>, <code>-gt</code>, <code>-ge</code></li></ul></li> <li>示例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$name</span> <span class="token operator">=~</span> ^<span class="token punctuation">[</span>a-z<span class="token punctuation">]</span><span class="token punctuation">[</span>a-z0-9_<span class="token punctuation">]</span>+$ <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;valid&quot;</span>
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr> <h2 id="_7-循环、break-与-continue"><a href="#_7-循环、break-与-continue" class="header-anchor">#</a> 7. 循环、<code>break</code> 与 <code>continue</code></h2> <h3 id="循环结构"><a href="#循环结构" class="header-anchor">#</a> 循环结构</h3> <ul><li><code>for var in list; do ... done</code></li> <li><code>while condition; do ... done</code></li> <li><code>until condition; do ... done</code>（直到条件为真时停止）</li></ul> <h3 id="break-与-continue"><a href="#break-与-continue" class="header-anchor">#</a> <code>break</code> 与 <code>continue</code></h3> <ul><li><code>break</code>：跳出当前循环；<code>break N</code>：跳出 N 层嵌套循环（Bash 支持）。</li> <li><code>continue</code>：跳到当前循环的下次迭代；<code>continue N</code>：跳过 N 层循环的当前迭代（通常用 <code>continue</code>）。</li></ul> <p>示例（嵌套循环 + break/continue）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">for</span> <span class="token for-or-select variable">j</span> <span class="token keyword">in</span> <span class="token punctuation">{</span>a<span class="token punctuation">..</span>c<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$i</span><span class="token variable">$j</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;2b&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;found 2b -&gt; break 2&quot;</span>
      <span class="token builtin class-name">break</span> <span class="token number">2</span>      <span class="token comment"># 跳出外层和内层</span>
    <span class="token keyword">fi</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$j</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token builtin class-name">continue</span>    <span class="token comment"># 内层继续下一次 j</span>
    <span class="token keyword">fi</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$i</span> <span class="token variable">$j</span>&quot;</span>
  <span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr> <h2 id="_8-函数-组织脚本逻辑的最好方式"><a href="#_8-函数-组织脚本逻辑的最好方式" class="header-anchor">#</a> 8. 函数（组织脚本逻辑的最好方式）</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function-name function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span>     <span class="token comment"># local 防止污染外部变量</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Hello, <span class="token variable">$name</span>&quot;</span>
<span class="token punctuation">}</span>

<span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>greet <span class="token string">&quot;ikun&quot;</span><span class="token variable">)</span></span>  <span class="token comment"># 函数可以 echo 输出作为返回值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><code>return N</code>：返回整数退出码（0 表示成功）；想返回字符串用 <code>echo</code> 并捕获。</li></ul> <hr> <h2 id="_9-i-o、重定向、管道与-here-doc"><a href="#_9-i-o、重定向、管道与-here-doc" class="header-anchor">#</a> 9. I/O、重定向、管道与 here-doc</h2> <ul><li><code>&gt;</code> 覆盖写；<code>&gt;&gt;</code> 追加写</li> <li><code>2&gt;</code> 单独重定向 stderr；<code>&amp;&gt;</code> 同时重定向 stdout/stderr（非 POSIX）</li> <li><code>cmd1 | cmd2</code> 管道。使用 <code>set -o pipefail</code> 以确保管道失败传播。</li> <li>Here-doc：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">'EOF'<span class="token bash punctuation"> <span class="token operator">&gt;</span> file.txt</span>
多行文本，变量不替换（因为用单引号）
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr> <h2 id="_10-echo-vs-printf"><a href="#_10-echo-vs-printf" class="header-anchor">#</a> 10. <code>echo</code> vs <code>printf</code></h2> <ul><li><code>echo</code>：简单打印，行为随 shell 版本和 <code>-e</code> 标志不同（<code>\n</code>, <code>\t</code> 等）。
<ul><li><code>echo -n</code>：不输出末尾换行</li> <li><code>echo -e</code>：解释转义（不总是可移植）</li></ul></li> <li><code>printf</code>：推荐用于可移植、格式化输出：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">printf</span> <span class="token string">&quot;Name: %s<span class="token entity" title="\t">\t</span>Score: %d<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;Alice&quot;</span> <span class="token number">92</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <h2 id="_11-错误处理、trap-与清理"><a href="#_11-错误处理、trap-与清理" class="header-anchor">#</a> 11. 错误处理、<code>trap</code> 与清理</h2> <ul><li><code>trap 'handler' EXIT</code>：无论怎样退出都会执行 handler（可用于清理临时文件）。</li> <li>捕获信号：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">trap</span> <span class="token string">'echo &quot;Interrupted&quot;; exit 2'</span> INT <span class="token environment constant">TERM</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <h2 id="_12-常用工具-安全建议-最佳实践"><a href="#_12-常用工具-安全建议-最佳实践" class="header-anchor">#</a> 12. 常用工具/安全建议（最佳实践）</h2> <ul><li>在脚本头使用 <code>set -euo pipefail</code>。</li> <li>使用双引号引用变量 <code>&quot;$var&quot;</code>。</li> <li>对外部命令结果做检查（不要盲信成功）。</li> <li>用 <code>mktemp</code> 创建临时文件，使用 <code>trap</code> 清理。</li> <li>对输入参数做校验并提供 <code>usage()</code>。</li> <li>对用户可见的信息用 <code>printf</code> 而非 <code>echo</code>（格式更稳定）。</li></ul> <hr> <h2 id="_13-参数解析-getopts-推荐-示例"><a href="#_13-参数解析-getopts-推荐-示例" class="header-anchor">#</a> 13. 参数解析：<code>getopts</code>（推荐）示例</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># getopt style parsing using getopts</span>
<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">&quot;:f:k:h&quot;</span> opt<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>
    f<span class="token punctuation">)</span> <span class="token assign-left variable">logfile</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    k<span class="token punctuation">)</span> <span class="token assign-left variable">keyword</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    h<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;usage...&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">\</span>?<span class="token punctuation">)</span> <span class="token builtin class-name">printf</span> <span class="token string">&quot;Invalid option -%s<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>
<span class="token builtin class-name">shift</span> <span class="token variable"><span class="token variable">$((</span>OPTIND<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr> <h2 id="_14-典型脚本模板-可拷贝到任何项目"><a href="#_14-典型脚本模板-可拷贝到任何项目" class="header-anchor">#</a> 14. 典型脚本模板（可拷贝到任何项目）</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-euo</span> pipefail

<span class="token function-name function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
Usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">&quot;<span class="token variable">$0</span>&quot;</span><span class="token variable">)</span></span> -f logfile [-k keyword]
EOF</span>
<span class="token punctuation">}</span>

<span class="token assign-left variable">logfile</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">keyword</span><span class="token operator">=</span><span class="token string">&quot;ERROR&quot;</span>

<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">&quot;:f:k:h&quot;</span> opt<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>
    f<span class="token punctuation">)</span> <span class="token assign-left variable">logfile</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    k<span class="token punctuation">)</span> <span class="token assign-left variable">keyword</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    h<span class="token punctuation">)</span> usage<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">\</span>?<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Invalid option -<span class="token variable">$OPTARG</span>&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span> usage<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">&quot;<span class="token variable">${logfile}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;logfile required&quot;</span>
  usage
  <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">trap</span> <span class="token string">'echo &quot;Cleaning up&quot;; rm -f &quot;$tmpfile&quot;'</span> EXIT

<span class="token comment"># main logic...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><hr> <h2 id="_15-综合实例-把上面要点都串起来-robust-log-tool-sh"><a href="#_15-综合实例-把上面要点都串起来-robust-log-tool-sh" class="header-anchor">#</a> 15. 综合实例（把上面要点都串起来） — <code>robust_log_tool.sh</code></h2> <blockquote><p>这是一个“工程化”脚本范例，演示变量（含默认/环境变量）、引用、函数、数组、循环、break/continue、trap、导出、<code>getopts</code>、<code>printf</code>、以及日志处理实战。</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-euo</span> pipefail

<span class="token comment"># 默认配置（可由环境变量覆盖）</span>
<span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">${LOGFILE<span class="token operator">:=</span>${1<span class="token operator">:-</span>.<span class="token operator">/</span>app.log}</span>}&quot;</span>
<span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">${ARCHIVE_DIR<span class="token operator">:=</span>.<span class="token operator">/</span>log_archive}</span>&quot;</span>
<span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">${SIZE_LIMIT<span class="token operator">:=</span>1048576}</span>&quot;</span>   <span class="token comment"># 1 MB default</span>

<span class="token function-name function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
Usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">&quot;<span class="token variable">$0</span>&quot;</span><span class="token variable">)</span></span> [-f logfile] [-s size_limit_bytes]
Environment:
  LOGFILE    default: ./app.log or first positional arg
  ARCHIVE_DIR default: ./log_archive
EOF</span>
<span class="token punctuation">}</span>

<span class="token comment"># 参数解析（简单示例）</span>
<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">&quot;:f:s:h&quot;</span> opt<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>
    f<span class="token punctuation">)</span> <span class="token assign-left variable">LOGFILE</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    s<span class="token punctuation">)</span> <span class="token assign-left variable">SIZE_LIMIT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$OPTARG</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    h<span class="token punctuation">)</span> usage<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">\</span>?<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;Invalid option -<span class="token variable">$OPTARG</span>&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span> usage<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token comment"># 依赖检查</span>
<span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> <span class="token function">gzip</span> <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;gzip required&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment"># 函数：归档日志（如果过大）</span>
<span class="token function-name function">archive_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">dir</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$2</span>&quot;</span>
  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$dir</span>&quot;</span>
  <span class="token builtin class-name">local</span> ts
  <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&quot;%Y%m%dT%H%M%S&quot;</span><span class="token variable">)</span></span>
  <span class="token builtin class-name">local</span> base
  <span class="token assign-left variable">base</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span><span class="token variable">)</span></span>
  <span class="token function">mv</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${dir}</span>/<span class="token variable">${base}</span>.<span class="token variable">${ts}</span>&quot;</span>
  <span class="token function">gzip</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">${dir}</span>/<span class="token variable">${base}</span>.<span class="token variable">${ts}</span>&quot;</span>
  <span class="token builtin class-name">printf</span> <span class="token string">&quot;Archived %s -&gt; %s/%s.%s.gz<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$dir</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$base</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$ts</span>&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 函数：统计并打印基本信息</span>
<span class="token function-name function">summarize_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;No log file: <span class="token variable">$file</span>&quot;</span>
    <span class="token builtin class-name">return</span> <span class="token number">0</span>
  <span class="token keyword">fi</span>
  <span class="token builtin class-name">printf</span> <span class="token string">&quot;Summary for %s<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span>
  <span class="token builtin class-name">printf</span> <span class="token string">&quot;  Lines: %d<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">wc</span> <span class="token parameter variable">-l</span> <span class="token operator">&lt;</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span><span class="token variable">)</span></span>&quot;</span>
  <span class="token builtin class-name">printf</span> <span class="token string">&quot;  ERROR: %d<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token parameter variable">-E</span> <span class="token string">'ERROR|error'</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span> <span class="token operator">||</span> <span class="token boolean">true</span><span class="token variable">)</span></span>&quot;</span>
  <span class="token builtin class-name">printf</span> <span class="token string">&quot;  WARN: %d<span class="token entity" title="\n">\n</span>&quot;</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token parameter variable">-E</span> <span class="token string">'WARN|warn|WARNING'</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span> <span class="token operator">||</span> <span class="token boolean">true</span><span class="token variable">)</span></span>&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 主逻辑：如果文件大于 SIZE_LIMIT 则归档</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">stat</span> -c%s <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span><span class="token variable">)</span></span>
  <span class="token keyword">if</span> <span class="token variable"><span class="token punctuation">((</span> size <span class="token operator">&gt;</span> SIZE_LIMIT <span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    archive_log <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$ARCHIVE_DIR</span>&quot;</span>
    <span class="token comment"># 创建新的空文件</span>
    <span class="token builtin class-name">:</span> <span class="token operator">&gt;</span> <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span>
  <span class="token keyword">fi</span>
<span class="token keyword">fi</span>

<span class="token comment"># 遍历日志，演示 break/continue：</span>
<span class="token comment"># 找到第一个 ERROR 就停止（break），跳过 DEBUG lines（continue）</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token keyword">while</span> <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span> <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> line<span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token comment"># skip empty lines</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">&quot;<span class="token variable">$line</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">continue</span>
    <span class="token comment"># skip debug</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$line</span>&quot;</span> <span class="token operator">=~</span> DEBUG <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token builtin class-name">continue</span>
    <span class="token keyword">fi</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;LINE: <span class="token variable">$line</span>&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$line</span>&quot;</span> <span class="token operator">=~</span> ERROR<span class="token operator">|</span>error <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;Found first error, stopping scan.&quot;</span>
      <span class="token builtin class-name">break</span>
    <span class="token keyword">fi</span>
  <span class="token keyword">done</span> <span class="token operator">&lt;</span> <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span>
<span class="token keyword">fi</span>

<span class="token comment"># 最后打印摘要</span>
summarize_log <span class="token string">&quot;<span class="token variable">$LOGFILE</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><ul><li>说明：
<ul><li><code>: &gt; &quot;$LOGFILE&quot;</code> 用来重建或清空文件（冒号是个 no-op command）。</li> <li><code>stat -c%s</code> 用于获取文件字节大小（Linux）。</li> <li><code>grep -c ... || true</code> 以防找不到匹配导致非0退出（因为 <code>set -e</code>）。</li></ul></li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/10/08, 22:57:05</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/Linux_02/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">02.nano 编辑器</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/Linux_02/" class="prev">02.nano 编辑器</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://github.com/liehuf" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="mailto:17715076182@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://blog.csdn.net/liehuf" title="CSDN" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/44-97-46-49" title="知乎" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2025-2025
    <span>liehuf | <a href="https://github.com/liehuf/liehuf-notes/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.62496645.js" defer></script><script src="/assets/js/2.b05449e5.js" defer></script><script src="/assets/js/53.fa262586.js" defer></script>
  </body>
</html>
